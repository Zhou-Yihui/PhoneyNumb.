<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¤§å‡‰å›½äº‘é€šä¿¡</title>
<meta name="theme-color" content="#004bbb">
<style>
:root{--main:#004bbb;--bg:#f4f4f9}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;background:var(--bg)}
header{background:var(--main);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
#screen{max-width:600px;margin:0 auto;background:#fff;min-height:100vh;display:flex;flex-direction:column}
#nav{display:flex;border-bottom:1px solid #ddd}
#nav button{flex:1;padding:10px;border:none;background:#fff;cursor:pointer;transition:.2s}
#nav button.active{background:var(--main);color:#fff}
.page{display:none;padding:16px;flex:1}
.page.active{display:block}
input,textarea,select{width:100%;padding:8px;margin:6px 0;box-sizing:border-box;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;border:none;border-radius:4px;background:var(--main);color:#fff;cursor:pointer}
button:disabled{background:#aaa}
.call-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.call-pad button{padding:18px;font-size:20px}
#callStatus{font-size:18px;margin:10px 0}
#msgList{max-height:40vh;overflow:auto;border:1px solid #ddd;padding:6px;border-radius:4px;background:#fafafa}
.msg{margin:4px 0;padding:4px;border-radius:4px;max-width:80%;word-wrap:break-word}.msg.me{text-align:right;margin-left:auto;background:#e3f2fd}.msg.other{margin-right:auto;background:#f5f5f5}
.group-invite{background:#ffe7ba;padding:6px;border-radius:4px;margin:4px 0}
#phoneList,#groupList,#callHistory{list-style:none;padding:0}
#phoneList li,#groupList li,#callHistory li{background:#f9f9f9;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
/* é€šè¯å¼¹çª— */
.call-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;z-index:999}
.call-modal.hidden{display:none}
.call-controls{display:flex;gap:20px;margin-top:40px}
.call-controls button{width:60px;height:60px;border-radius:50%;font-size:20px;display:flex;align-items:center;justify-content:center}
.call-controls button.danger{background:#e74c3c}
</style>
</head>
<body>
<div id="screen">
  <header>
    <span>ğŸ“ å¤§å‡‰å›½äº‘é€šä¿¡</span>
    <span id="userInfo"></span>
    <button onclick="logout()" style="padding:4px 8px;font-size:14px;">é€€å‡º</button>
  </header>

  <nav id="nav">
    <button class="navBtn active" data-page="dialPage">æ‹¨å·</button>
    <button class="navBtn" data-page="smsPage">çŸ­ä¿¡</button>
    <button class="navBtn" data-page="groupPage">ç¾¤ç»„</button>
    <button onclick="location.href='./gen.html'">ç”Ÿå·</button>
  </nav>

  <!-- æ‹¨å· -->
  <section id="dialPage" class="page active">
    <h3>æ‹¨å·ç›˜</h3>
    <input id="dialNumber" placeholder="ä¾‹ï¼š+3-000-12345678">
    <div class="call-pad">
      <button onclick="press('1')">1</button><button onclick="press('2')">2</button><button onclick="press('3')">3</button>
      <button onclick="press('4')">4</button><button onclick="press('5')">5</button><button onclick="press('6')">6</button>
      <button onclick="press('7')">7</button><button onclick="press('8')">8</button><button onclick="press('9')">9</button>
      <button onclick="press('*')">*</button><button onclick="press('0')">0</button><button onclick="press('#')">#</button>
      <button onclick="delLast()" style="grid-column:2">âŒ«</button>
    </div>
    <button onclick="makeCall()">ğŸ“ æ‹¨æ‰“</button>
    <div id="callStatus">å°±ç»ª</div>
    <h4>æœ€è¿‘é€šè¯</h4>
    <ul id="callHistory"></ul>
  </section>

  <!-- çŸ­ä¿¡ -->
  <section id="smsPage" class="page">
    <h3>æ”¶å‘çŸ­ä¿¡</h3>
    <input id="smsTo" placeholder="æ¥æ”¶æ–¹å·ç /ç¾¤ç»„IDï¼ˆç¾¤ç»„ä»¥gå¼€å¤´ï¼‰">
    <textarea id="smsBody" rows="3" placeholder="çŸ­ä¿¡å†…å®¹" maxlength="500"></textarea>
    <button onclick="sendSms()">å‘é€</button>
    <h4>èŠå¤©è®°å½•</h4>
    <div id="msgList"></div>
  </section>

  <!-- ç¾¤ç»„ -->
  <section id="groupPage" class="page">
    <h3>ç¾¤ç»„</h3>
    <input id="groupName" placeholder="æ–°ç¾¤ç»„åç§°" maxlength="30">
    <button onclick="createGroup()">åˆ›å»ºç¾¤ç»„</button>
    <h4>æˆ‘çš„ç¾¤ç»„</h4>
    <ul id="groupList"></ul>
    <h4>é‚€è¯·é“¾æ¥ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰</h4>
    <input id="inviteLink" readonly>
    <button onclick="joinFromLink()">é€šè¿‡é“¾æ¥åŠ å…¥</button>
  </section>
</div>

<!-- é€šè¯å¼¹çª— -->
<div id="callModal" class="call-modal hidden">
  <h2 id="callerInfo">æ­£åœ¨é€šè¯ä¸­...</h2>
  <div class="call-controls">
    <button class="danger" onclick="endCall()">âŒ</button>
    <button onclick="answerCall()" id="answerBtn" style="background:#2ecc71">ğŸ“</button>
  </div>
</div>

<script>
/* ===================== æ ¸å¿ƒé…ç½® ===================== */
const STORAGE_KEYS = {
  currentUser: 'dl_currentUser',
  userPhoneMap: 'dl_userPhoneMap', // ç”¨æˆ·å-å·ç æ˜ å°„ï¼š{ ç”¨æˆ·å: å·ç  }
  users: 'dl_users', // æ‰€æœ‰ç”¨æˆ·ï¼š{ å·ç : { name: æ˜µç§°, online: å¸ƒå°”å€¼, lastOnline: æ—¶é—´æˆ³ } }
  sms: 'dl_sms', // çŸ­ä¿¡è®°å½•ï¼š[{ from, to, body, time, type: 'private/group' }]
  calls: 'dl_calls', // é€šè¯è®°å½•ï¼š[{ target, type: 'in/out/missed', time, duration }]
  groups: 'dl_groups', // ç¾¤ç»„ï¼š{ ç¾¤ç»„ID: { name, owner, members: [å·ç åˆ—è¡¨] } }
  webrtcSignals: 'dl_webrtc_signals' // WebRTCä¿¡ä»¤ï¼š{ ç›®æ ‡å·ç : [ä¿¡ä»¤å¯¹è±¡] }
};

/* ===================== å…¨å±€å˜é‡ ===================== */
let currentUser; // å½“å‰ç”¨æˆ·ï¼š{ name: ç”¨æˆ·å, phone: å·ç  }
let rtcConnections = {}; // WebRTCè¿æ¥ï¼š{ å¯¹æ–¹å·ç : RTCPeerConnection }
let dataChannels = {}; // æ•°æ®é€šé“ï¼š{ å¯¹æ–¹å·ç /ç¾¤ç»„ID: RTCDataChannel }
let currentCall = null; // å½“å‰é€šè¯ï¼š{ target, isIncoming, startTime, stream }
let localAudioStream = null; // æœ¬åœ°éŸ³é¢‘æµ

/* ===================== å·¥å…·å‡½æ•° ===================== */
function getStorage(key) {
  try {
    return JSON.parse(localStorage.getItem(key) || '{}');
  } catch (e) {
    localStorage.removeItem(key);
    return {};
  }
}

function setStorage(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

function formatTime(timestamp) {
  return new Date(timestamp).toLocaleString('zh-CN', {
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// ç”Ÿæˆå”¯ä¸€ID
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// å‘é€WebRTCä¿¡ä»¤
function sendWebrtcSignal(targetPhone, signal) {
  const signals = getStorage(STORAGE_KEYS.webrtcSignals);
  if (!signals[targetPhone]) signals[targetPhone] = [];
  signals[targetPhone].push({ from: currentUser.phone, signal, time: Date.now() });
  setStorage(STORAGE_KEYS.webrtcSignals, signals);
}

// å¤„ç†æ”¶åˆ°çš„WebRTCä¿¡ä»¤
function handleWebrtcSignal(signalData) {
  const { from: callerPhone, signal } = signalData;
  const { type, sdp, candidate } = signal;

  // å¿½ç•¥è‡ªå·±å‘é€çš„ä¿¡ä»¤
  if (callerPhone === currentUser.phone) return;

  switch (type) {
    case 'offer':
      handleIncomingCall(callerPhone, sdp);
      break;
    case 'answer':
      handleAnswer(callerPhone, sdp);
      break;
    case 'candidate':
      handleCandidate(callerPhone, candidate);
      break;
    case 'hangup':
      handleHangup(callerPhone);
      break;
    default:
      break;
  }
}

// åˆå§‹åŒ–æ•°æ®é€šé“
function initDataChannel(dc, target) {
  dc.onopen = () => {
    console.log(`ä¸ ${target} çš„æ•°æ®é€šé“å·²æ‰“å¼€`);
    dataChannels[target] = dc;
  };

  dc.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'sms') {
      // æ¥æ”¶çŸ­ä¿¡
      const smsList = getStorage(STORAGE_KEYS.sms);
      smsList.push({
        from: target,
        to: currentUser.phone,
        body: data.body,
        time: Date.now(),
        type: 'private'
      });
      setStorage(STORAGE_KEYS.sms, smsList);
      if (document.getElementById('smsPage').classList.contains('active')) {
        renderSms();
      }
      pushNotification(`æ–°çŸ­ä¿¡æ¥è‡ª ${target}`);
    } else if (data.type === 'group-sms') {
      // æ¥æ”¶ç¾¤ç»„çŸ­ä¿¡
      const smsList = getStorage(STORAGE_KEYS.sms);
      smsList.push({
        from: data.from,
        to: data.groupId,
        body: data.body,
        time: Date.now(),
        type: 'group'
      });
      setStorage(STORAGE_KEYS.sms, smsList);
      if (document.getElementById('smsPage').classList.contains('active')) {
        renderSms();
      }
      pushNotification(`æ–°ç¾¤ç»„çŸ­ä¿¡æ¥è‡ª ${data.groupName}`);
    }
  };

  dc.onclose = () => {
    console.log(`ä¸ ${target} çš„æ•°æ®é€šé“å·²å…³é—­`);
    delete dataChannels[target];
  };
}

/* ===================== åˆå§‹åŒ– ===================== */
(function init() {
  // ç™»å½•æ ¡éªŒ
  const userName = localStorage.getItem(STORAGE_KEYS.currentUser);
  if (!userName) {
    location.href = './index.html';
    return;
  }

  // ç»‘å®šç”¨æˆ·å·ç ï¼ˆä»gen.htmlç”Ÿæˆçš„å·ç ï¼‰
  const userPhoneMap = getStorage(STORAGE_KEYS.userPhoneMap);
  const userPhone = userPhoneMap[userName];
  if (!userPhone || !userPhone.startsWith('+3')) {
    const phone = prompt('è¯·ç»‘å®šä½ çš„å¤§å‡‰å›½ç”µè¯å·ç ï¼ˆä»"ç”Ÿå·"é¡µé¢ç”Ÿæˆï¼‰ï¼š');
    if (!phone || !phone.startsWith('+3')) {
      alert('æ— æ•ˆå·ç ï¼è¯·é‡æ–°ç™»å½•');
      logout();
      return;
    }
    userPhoneMap[userName] = phone;
    setStorage(STORAGE_KEYS.userPhoneMap, userPhoneMap);

    // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
    const users = getStorage(STORAGE_KEYS.users);
    users[phone] = { name: userName, online: true, lastOnline: Date.now() };
    setStorage(STORAGE_KEYS.users, users);
  }

  // æ ‡è®°å½“å‰ç”¨æˆ·åœ¨çº¿
  const users = getStorage(STORAGE_KEYS.users);
  users[userPhone] = { ...users[userPhone], online: true, lastOnline: Date.now() };
  setStorage(STORAGE_KEYS.users, users);

  // åˆå§‹åŒ–å½“å‰ç”¨æˆ·ä¿¡æ¯
  currentUser = { name: userName, phone: userPhone };
  document.getElementById('userInfo').textContent = `${currentUser.name} (${currentUser.phone})`;

  // åˆå§‹åŒ–WebRTCä¿¡ä»¤ç›‘å¬
  initWebrtcSignalListener();

  // é¡µé¢åˆ‡æ¢äº‹ä»¶ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
  document.querySelectorAll('.navBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.navBtn').forEach(b => b.classList.remove('active'));
      const page = document.getElementById(btn.dataset.page);
      if (page) page.classList.add('active');
      btn.classList.add('active');
      if (btn.dataset.page === 'smsPage') renderSms();
      if (btn.dataset.page === 'groupPage') renderGroups();
      if (btn.dataset.page === 'dialPage') renderCallHistory();
    });
  });

  // é¡µé¢å…³é—­æ—¶æ ‡è®°ç¦»çº¿
  window.addEventListener('beforeunload', () => {
    const users = getStorage(STORAGE_KEYS.users);
    if (users[currentUser.phone]) {
      users[currentUser.phone].online = false;
      users[currentUser.phone].lastOnline = Date.now();
      setStorage(STORAGE_KEYS.users, users);
    }
    // å…³é—­æ‰€æœ‰é€šè¯å’Œè¿æ¥
    if (currentCall) endCall();
    Object.values(rtcConnections).forEach(pc => pc.close());
  });

  // åˆå§‹åŒ–é€šçŸ¥æƒé™
  if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
    Notification.requestPermission();
  }

  // åˆå§‹æ¸²æŸ“
  renderSms();
  renderGroups();
  renderCallHistory();
})();

/* ===================== WebRTCä¿¡ä»¤ç›‘å¬ ===================== */
function initWebrtcSignalListener() {
  // å®šæœŸæ£€æŸ¥æ–°ä¿¡ä»¤ï¼ˆçº¯å‰ç«¯æ¨¡æ‹Ÿä¿¡ä»¤æœåŠ¡å™¨ï¼‰
  setInterval(() => {
    const signals = getStorage(STORAGE_KEYS.webrtcSignals);
    const mySignals = signals[currentUser.phone] || [];
    if (mySignals.length > 0) {
      mySignals.forEach(signalData => handleWebrtcSignal(signalData));
      // æ¸…ç©ºå·²å¤„ç†çš„ä¿¡ä»¤
      signals[currentUser.phone] = [];
      setStorage(STORAGE_KEYS.webrtcSignals, signals);
    }
  }, 1000);
}

/* ===================== é€šè¯åŠŸèƒ½ ===================== */
function press(ch) {
  document.getElementById('dialNumber').value += ch;
}

function delLast() {
  const input = document.getElementById('dialNumber');
  input.value = input.value.slice(0, -1);
}

// å‘èµ·é€šè¯
async function makeCall() {
  const targetPhone = document.getElementById('dialNumber').value.trim();
  if (!targetPhone || !targetPhone.startsWith('+3')) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤§å‡‰å›½å·ç ï¼ˆä»¥+3å¼€å¤´ï¼‰');
    return;
  }

  // æ£€æŸ¥å¯¹æ–¹æ˜¯å¦å­˜åœ¨
  const users = getStorage(STORAGE_KEYS.users);
  if (!users[targetPhone]) {
    alert('å¯¹æ–¹å·ç æœªæ³¨å†Œ');
    return;
  }

  // é¿å…é‡å¤é€šè¯
  if (currentCall) {
    alert('å½“å‰å·²æœ‰é€šè¯è¿›è¡Œä¸­');
    return;
  }

  currentCall = { target: targetPhone, isIncoming: false, startTime: null };
  document.getElementById('callStatus').textContent = `æ­£åœ¨å‘¼å« ${targetPhone}...`;
  document.getElementById('callerInfo').
textContent = `å‘¼å« ${targetPhone}`;
  document.getElementById('answerBtn').style.display = 'none';
  document.getElementById('callModal').classList.remove('hidden');

  try {
    // è·å–æœ¬åœ°éŸ³é¢‘æµ
    localAudioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // åˆ›å»ºWebRTCè¿æ¥
    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }, // å…¬å…±STUNæœåŠ¡å™¨ï¼Œç”¨äºNATç©¿é€
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    });
    rtcConnections[targetPhone] = pc;

    // æ·»åŠ æœ¬åœ°æµåˆ°è¿æ¥
    localAudioStream.getTracks().forEach(track => pc.addTrack(track, localAudioStream));

    // ç›‘å¬è¿œç¨‹æµï¼ˆå¯¹æ–¹éŸ³é¢‘ï¼‰
    pc.ontrack = (e) => {
      if (e.streams && e.streams[0]) {
        currentCall.stream = e.streams[0];
        // æ’­æ”¾å¯¹æ–¹éŸ³é¢‘ï¼ˆåˆ›å»ºéšè—audioå…ƒç´ ï¼‰
        const audio = document.createElement('audio');
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        audio.hidden = true;
        document.body.appendChild(audio);
      }
    };

    // åˆ›å»ºæ•°æ®é€šé“ï¼ˆç”¨äºé€šè¯æ§åˆ¶å’ŒçŸ­ä¿¡ï¼‰
    const dc = pc.createDataChannel('call-control');
    initDataChannel(dc, targetPhone);

    // ç›‘å¬ICEå€™é€‰
    pc.onicecandidate = e => {
      if (e.candidate) {
        sendWebrtcSignal(targetPhone, { type: 'candidate', candidate: e.candidate.toJSON() });
      }
    };

    // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
    pc.onconnectionstatechange = () => {
      if (pc.connectionState === 'connected') {
        document.getElementById('callStatus').textContent = `ä¸ ${targetPhone} é€šè¯ä¸­`;
        document.getElementById('callerInfo').textContent = `ä¸ ${targetPhone} é€šè¯ä¸­`;
        currentCall.startTime = Date.now();
      } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed' || pc.connectionState === 'closed') {
        if (currentCall) endCall();
      }
    };

    // åˆ›å»ºofferå¹¶å‘é€
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendWebrtcSignal(targetPhone, { type: 'offer', sdp: offer.sdp });

  } catch (err) {
    console.error('å‘èµ·é€šè¯å¤±è´¥ï¼š', err);
    alert('è·å–éº¦å…‹é£æƒé™å¤±è´¥æˆ–é€šè¯åˆå§‹åŒ–å¤±è´¥');
    endCall();
  }
}

// å¤„ç†æ¥ç”µ
function handleIncomingCall(callerPhone, sdp) {
  // é¿å…é‡å¤é€šè¯
  if (currentCall) {
    sendWebrtcSignal(callerPhone, { type: 'hangup' });
    return;
  }

  // è·å–å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯
  const users = getStorage(STORAGE_KEYS.users);
  const callerName = users[callerPhone]?.name || callerPhone;

  currentCall = { target: callerPhone, isIncoming: true, startTime: null, stream: null };
  document.getElementById('callStatus').textContent = `æ¥è‡ª ${callerName} çš„æ¥ç”µ...`;
  document.getElementById('callerInfo').textContent = `æ¥ç”µï¼š${callerName}`;
  document.getElementById('answerBtn').style.display = 'flex';
  document.getElementById('callModal').classList.remove('hidden');

  // åˆ›å»ºWebRTCè¿æ¥
  const pc = new RTCPeerConnection({
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' }
    ]
  });
  rtcConnections[callerPhone] = pc;

  // ç›‘å¬è¿œç¨‹æµï¼ˆå¯¹æ–¹éŸ³é¢‘ï¼‰
  pc.ontrack = (e) => {
    if (e.streams && e.streams[0]) {
      currentCall.stream = e.streams[0];
      const audio = document.createElement('audio');
      audio.srcObject = e.streams[0];
      audio.autoplay = true;
      audio.hidden = true;
      document.body.appendChild(audio);
    }
  };

  // ç›‘å¬æ•°æ®é€šé“ï¼ˆå¯¹æ–¹åˆ›å»ºçš„ï¼‰
  pc.ondatachannel = (e) => {
    initDataChannel(e.channel, callerPhone);
  };

  // ç›‘å¬ICEå€™é€‰
  pc.onicecandidate = e => {
    if (e.candidate) {
      sendWebrtcSignal(callerPhone, { type: 'candidate', candidate: e.candidate.toJSON() });
    }
  };

  // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
  pc.onconnectionstatechange = () => {
    if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed' || pc.connectionState === 'closed') {
      if (currentCall) endCall();
    }
  };

  // è®¾ç½®è¿œç¨‹æè¿°ï¼ˆæ¥ç”µofferï¼‰
  pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }))
    .catch(err => {
      console.error('è®¾ç½®è¿œç¨‹æè¿°å¤±è´¥ï¼š', err);
      endCall();
    });
}

// å¤„ç†é€šè¯åº”ç­”
async function answerCall() {
  if (!currentCall || currentCall.isIncoming !== true) return;

  const targetPhone = currentCall.target;
  document.getElementById('answerBtn').style.display = 'none';
  document.getElementById('callStatus').textContent = `ä¸ ${targetPhone} é€šè¯ä¸­`;
  document.getElementById('callerInfo').textContent = `ä¸ ${targetPhone} é€šè¯ä¸­`;

  try {
    // è·å–æœ¬åœ°éŸ³é¢‘æµ
    localAudioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // è·å–å·²åˆ›å»ºçš„RTCPeerConnection
    const pc = rtcConnections[targetPhone];
    if (!pc) throw new Error('æœªæ‰¾åˆ°é€šè¯è¿æ¥');

    // æ·»åŠ æœ¬åœ°æµåˆ°è¿æ¥
    localAudioStream.getTracks().forEach(track => pc.addTrack(track, localAudioStream));

    // åˆ›å»ºanswerå¹¶å‘é€
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    sendWebrtcSignal(targetPhone, { type: 'answer', sdp: answer.sdp });

    currentCall.startTime = Date.now();

  } catch (err) {
    console.error('æ¥å¬é€šè¯å¤±è´¥ï¼š', err);
    alert('è·å–éº¦å…‹é£æƒé™å¤±è´¥æˆ–æ¥å¬å¤±è´¥');
    endCall();
  }
}

// å¤„ç†ICEå€™é€‰
function handleCandidate(targetPhone, candidate) {
  const pc = rtcConnections[targetPhone];
  if (pc) {
    pc.addIceCandidate(new RTCIceCandidate(candidate))
      .catch(err => console.error('æ·»åŠ ICEå€™é€‰å¤±è´¥ï¼š', err));
  }
}

// å¤„ç†å¯¹æ–¹æŒ‚æ–­
function handleHangup(targetPhone) {
  if (currentCall && currentCall.target === targetPhone) {
    const duration = currentCall.startTime ? Math.floor((Date.now() - currentCall.startTime) / 1000) : 0;
    // ä¿å­˜é€šè¯è®°å½•ï¼ˆæœªæ¥/å·²æ¥ï¼‰
    const callType = currentCall.isIncoming ? (currentCall.startTime ? 'in' : 'missed') : 'out';
    saveCallRecord(targetPhone, callType, duration);
    
    // æ¸…ç†é€šè¯çŠ¶æ€
    clearCallState();
    document.getElementById('callStatus').textContent = `å¯¹æ–¹å·²æŒ‚æ–­ï¼ˆæ—¶é•¿ï¼š${formatDuration(duration)}ï¼‰`;
    pushNotification(`é€šè¯ç»“æŸï¼š${targetPhone}`);
  }
}

// ç»“æŸé€šè¯
function endCall() {
  if (!currentCall) return;

  const targetPhone = currentCall.target;
  const pc = rtcConnections[targetPhone];

  // å‘é€æŒ‚æ–­ä¿¡ä»¤
  sendWebrtcSignal(targetPhone, { type: 'hangup' });

  // è®¡ç®—é€šè¯æ—¶é•¿
  const duration = currentCall.startTime ? Math.floor((Date.now() - currentCall.startTime) / 1000) : 0;

  // ä¿å­˜é€šè¯è®°å½•
  const callType = currentCall.isIncoming ? (currentCall.startTime ? 'in' : 'missed') : 'out';
  saveCallRecord(targetPhone, callType, duration);

  // æ¸…ç†é€šè¯çŠ¶æ€
  clearCallState();

  // å…³é—­WebRTCè¿æ¥
  if (pc) {
    pc.close();
    delete rtcConnections[targetPhone];
  }

  // åœæ­¢æœ¬åœ°éŸ³é¢‘æµ
  if (localAudioStream) {
    localAudioStream.getTracks().forEach(track => track.stop());
    localAudioStream = null;
  }

  // ç§»é™¤è¿œç¨‹éŸ³é¢‘å…ƒç´ 
  document.querySelectorAll('audio[hidden]').forEach(audio => audio.remove());

  document.getElementById('callStatus').textContent = `é€šè¯ç»“æŸï¼ˆæ—¶é•¿ï¼š${formatDuration(duration)}ï¼‰`;
  pushNotification(`é€šè¯ç»“æŸï¼š${targetPhone}`);
}

// æ ¼å¼åŒ–é€šè¯æ—¶é•¿
function formatDuration(seconds) {
  if (seconds < 60) return `${seconds}ç§’`;
  const min = Math.floor(seconds / 60);
  const sec = seconds % 60;
  return `${min}åˆ†${sec}ç§’`;
}

// ä¿å­˜é€šè¯è®°å½•
function saveCallRecord(target, type, duration) {
  const calls = getStorage(STORAGE_KEYS.calls);
  calls[Date.now()] = {
    target,
    type, // in: å·²æ¥æ¥ç”µ, out: å‘¼å‡º, missed: æœªæ¥æ¥ç”µ
    time: Date.now(),
    duration
  };
  setStorage(STORAGE_KEYS.calls, calls);
  renderCallHistory();
}

// æ¸…ç†é€šè¯çŠ¶æ€
function clearCallState() {
  currentCall = null;
  document.getElementById('callModal').classList.add('hidden');
}

/* ===================== çŸ­ä¿¡åŠŸèƒ½ ===================== */
async function sendSms() {
  const to = document.getElementById('smsTo').value.trim();
  const body = document.getElementById('smsBody').value.trim();
  if (!to || !body) {
    alert('è¯·è¾“å…¥æ¥æ”¶æ–¹å’ŒçŸ­ä¿¡å†…å®¹');
    return;
  }

  // åŒºåˆ†ç§äººçŸ­ä¿¡å’Œç¾¤ç»„çŸ­ä¿¡
  if (to.startsWith('g')) {
    // ç¾¤ç»„çŸ­ä¿¡
    const groups = getStorage(STORAGE_KEYS.groups);
    const group = groups[to];
    if (!group) {
      alert('ç¾¤ç»„ä¸å­˜åœ¨');
      return;
    }
    if (!group.members.includes(currentUser.phone)) {
      alert('ä½ ä¸æ˜¯è¯¥ç¾¤ç»„æˆå‘˜');
      return;
    }

    // ä¿å­˜ç¾¤ç»„çŸ­ä¿¡è®°å½•
    const smsList = getStorage(STORAGE_KEYS.sms);
    smsList.push({
      from: currentUser.phone,
      to: to,
      body,
      time: Date.now(),
      type: 'group'
    });
    setStorage(STORAGE_KEYS.sms, smsList);

    // å‘ç¾¤ç»„æ‰€æœ‰æˆå‘˜å‘é€ï¼ˆé€šè¿‡WebRTCæ•°æ®é€šé“ï¼‰
    group.members.forEach(member => {
      if (member === currentUser.phone) return;
      const dc = dataChannels[member];
      if (dc && dc.readyState === 'open') {
        dc.send(JSON.stringify({
          type: 'group-sms',
          from: currentUser.phone,
          groupId: to,
          groupName: group.name,
          body
        }));
      } else {
        // è‹¥æœªå»ºç«‹è¿æ¥ï¼Œæš‚å­˜ä¸ºç¦»çº¿çŸ­ä¿¡ï¼ˆçº¯å‰ç«¯æ¨¡æ‹Ÿï¼‰
        const offlineSms = getStorage('dl_offline_sms');
        if (!offlineSms[member]) offlineSms[member] = [];
        offlineSms[member].push({
          type: 'group-sms',
          from: currentUser.phone,
          groupId: to,
          groupName: group.name,
          body,
          time: Date.now()
        });
        setStorage('dl_offline_sms', offlineSms);
      }
    });

  } else {
    // ç§äººçŸ­ä¿¡
    if (!to.startsWith('+3')) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤§å‡‰å›½å·ç ï¼ˆä»¥+3å¼€å¤´ï¼‰');
      return;
    }

    const users = getStorage(STORAGE_KEYS.users);
    if (!users[to]) {
      alert('å¯¹æ–¹å·ç æœªæ³¨å†Œ');
      return;
    }

    // ä¿å­˜ç§äººçŸ­ä¿¡è®°å½•
    const smsList = getStorage(STORAGE_KEYS.sms);
    smsList.push({
      from: currentUser.phone,
      to,
      body,
      time: Date.now(),
      type: 'private'
    });
    setStorage(STORAGE_KEYS.sms, smsList);

    // é€šè¿‡WebRTCæ•°æ®é€šé“å‘é€
    let dc = dataChannels[to];
    if (!dc || dc.readyState !== 'open') {
      // è‹¥æœªå»ºç«‹è¿æ¥ï¼Œåˆ›å»ºä¸´æ—¶WebRTCè¿æ¥
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });
      dc = pc.createDataChannel('sms-channel');
      initDataChannel(dc, to);

      // ç›‘å¬ICEå€™é€‰
      pc.onicecandidate = e => {
        if (e.candidate) {
          sendWebrtcSignal(to, { type: 'sms-candidate', candidate: e.candidate.toJSON() });
        }
      };

      // åˆ›å»ºofferå¹¶å‘é€
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      sendWebrtcSignal(to, { type: 'sms-offer', sdp: offer.sdp });

      rtcConnections[`sms-${to}`] = pc;
    }

    // å‘é€çŸ­ä¿¡æ•°æ®
    dc.send(JSON.stringify({ type: 'sms', body }));
  }

  // æ¸…ç©ºè¾“å…¥æ¡†å¹¶åˆ·æ–°è®°å½•
  document.getElementById('smsBody').value = '';
  renderSms();
}

// æ¸²æŸ“çŸ­ä¿¡è®°å½•
function renderSms() {
  const box = document.getElementById('msgList');
  box.innerHTML = '';
  const smsList = getStorage(STORAGE_KEYS.sms);
  const currentPhone = currentUser.phone;

  // ç­›é€‰å½“å‰ç”¨æˆ·ç›¸å…³çš„çŸ­ä¿¡å¹¶æ’åº
  const mySms = Object.values(smsList)
    .filter(sms => sms.from === currentPhone || sms.to === currentPhone)
    .sort((a, b) => a.time - b.time);

  mySms.forEach(sms => {
    const div = document.createElement('div');
    div.className = `msg ${sms.from === currentPhone ? 'me' : 'other'}`;
    
    // æ˜¾ç¤ºå‘é€æ–¹/ç¾¤ç»„åç§°
    const users = getStorage(STORAGE_KEYS.users);
    const groups = getStorage(STORAGE_KEYS.groups);
    let senderName = sms.from;
    if (users[sms.from]) senderName = users[sms.from].name;
    if (sms.type === 'group' && groups[sms.to]) senderName = `${groups[sms.to].name} (${senderName})`;

    div.innerHTML = `
      <small style="font-size:10px;color:#666">${formatTime(sms.time)} ${senderName}</small><br>
      ${sms.body}
    `;
    box.appendChild(div);
  });

  // æ»šåŠ¨åˆ°åº•éƒ¨
  box.scrollTop = box.scrollHeight;
}

/* ===================== ç¾¤ç»„åŠŸèƒ½ ===================== */
function createGroup() {
  const groupName = document.getElementById('groupName').value.trim();
  if (!groupName) {
    alert('è¯·è¾“å…¥ç¾¤ç»„åç§°');
    return;
  }

  // ç”Ÿæˆç¾¤ç»„IDï¼ˆgå¼€å¤´ï¼‰
  const groupId = `g${generateUUID().replace(/-/g, '')}`;
  const groups = getStorage(STORAGE_KEYS.groups);

  // åˆ›å»ºç¾¤ç»„
  groups[groupId] = {
    name: groupName,
    owner: currentUser.phone,
    members: [currentUser.phone] // åˆå§‹æˆå‘˜ä¸ºåˆ›å»ºè€…
  };
  setStorage(STORAGE_KEYS.groups, groups);

  // æ›´æ–°å½“å‰ç”¨æˆ·çš„ç¾¤ç»„åˆ—è¡¨
  const users = getStorage(STORAGE_KEYS.users);
  if (!users[currentUser.phone].groups) users[currentUser.phone].groups = [];
  users[currentUser.phone].groups.push(groupId);
  setStorage(STORAGE_KEYS.users, users);

  // æ¸…ç©ºè¾“å…¥æ¡†å¹¶åˆ·æ–°ç¾¤ç»„åˆ—è¡¨
  document.getElementById('groupName').value = '';
  renderGroups();

  // ç”Ÿæˆé‚€è¯·é“¾æ¥
  const inviteLink = `${location.origin}${location.pathname.replace('app.html', '')}#invite=${groupId}`;
  document.getElementById('inviteLink').value = inviteLink;
  alert('ç¾¤ç»„åˆ›å»ºæˆåŠŸï¼é‚€è¯·é“¾æ¥å·²ç”Ÿæˆ');
}

// æ¸²æŸ“ç¾¤ç»„åˆ—è¡¨
function renderGroups() {
  const ul = document.getElementById('groupList');
  ul.innerHTML = '';
  const users = getStorage(STORAGE_KEYS.users);
  const groups = getStorage(STORAGE_KEYS.groups);
  const myGroups = users[currentUser.phone]?.groups || [];

  myGroups.forEach(groupId => {
    const group = groups[groupId];
    if (!group) return;

    const li = document.createElement('li');
    li.innerHTML =
`
      <span>${group.name}ï¼ˆæˆå‘˜ï¼š${group.members.length}äººï¼‰</span>
      <div>
        <button onclick="copyInviteLink('${groupId}')" style="margin-right:6px;padding:4px 8px;font-size:12px;">å¤åˆ¶é‚€è¯·</button>
        <button onclick="leaveGroup('${groupId}')" style="padding:4px 8px;font-size:12px;background:#e74c3c;">é€€å‡º</button>
      </div>
    `;
    ul.appendChild(li);
  });
}

// å¤åˆ¶ç¾¤ç»„é‚€è¯·é“¾æ¥
function copyInviteLink(groupId) {
  const inviteLink = `${location.origin}${location.pathname.replace('app.html', '')}#invite=${groupId}`;
  document.getElementById('inviteLink').value = inviteLink;
  
  // å¤åˆ¶åˆ°å‰ªè´´æ¿
  if (navigator.clipboard) {
    navigator.clipboard.writeText(inviteLink)
      .then(() => alert('é‚€è¯·é“¾æ¥å·²å¤åˆ¶'))
      .catch(() => alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶è¾“å…¥æ¡†ä¸­çš„é“¾æ¥'));
  } else {
    const input = document.getElementById('inviteLink');
    input.focus();
    input.select();
    document.execCommand('copy');
    alert('é‚€è¯·é“¾æ¥å·²å¤åˆ¶');
  }
}

// é€€å‡ºç¾¤ç»„
function leaveGroup(groupId) {
  if (!confirm('ç¡®å®šè¦é€€å‡ºè¯¥ç¾¤ç»„å—ï¼Ÿ')) return;

  const groups = getStorage(STORAGE_KEYS.groups);
  const users = getStorage(STORAGE_KEYS.users);
  const currentPhone = currentUser.phone;

  // ä»ç¾¤ç»„æˆå‘˜ä¸­ç§»é™¤
  groups[groupId].members = groups[groupId].members.filter(member => member !== currentPhone);
  
  // è‹¥é€€å‡ºåç¾¤ç»„æ— æˆå‘˜ï¼Œåˆ é™¤ç¾¤ç»„
  if (groups[groupId].members.length === 0) {
    delete groups[groupId];
  } else if (groups[groupId].owner === currentPhone) {
    // è‹¥ç¾¤ä¸»é€€å‡ºï¼ŒæŒ‡å®šç¬¬ä¸€ä¸ªæˆå‘˜ä¸ºæ–°ç¾¤ä¸»
    groups[groupId].owner = groups[groupId].members[0];
  }

  // ä»å½“å‰ç”¨æˆ·çš„ç¾¤ç»„åˆ—è¡¨ä¸­ç§»é™¤
  users[currentPhone].groups = users[currentPhone].groups.filter(id => id !== groupId);

  // ä¿å­˜ä¿®æ”¹
  setStorage(STORAGE_KEYS.groups, groups);
  setStorage(STORAGE_KEYS.users, users);

  // åˆ·æ–°ç¾¤ç»„åˆ—è¡¨
  renderGroups();
  pushNotification(`å·²é€€å‡ºç¾¤ç»„ï¼š${groups[groupId]?.name || 'æœªçŸ¥ç¾¤ç»„'}`);
}

// é€šè¿‡é“¾æ¥åŠ å…¥ç¾¤ç»„
function joinFromLink() {
  const rawLink = document.getElementById('inviteLink').value.trim();
  const match = rawLink.match(/invite=([^&]+)/);
  
  if (!match) {
    alert('æ— æ•ˆçš„é‚€è¯·é“¾æ¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ ¼å¼');
    return;
  }

  const groupId = match[1];
  const groups = getStorage(STORAGE_KEYS.groups);
  const users = getStorage(STORAGE_KEYS.users);
  const currentPhone = currentUser.phone;

  // æ£€æŸ¥ç¾¤ç»„æ˜¯å¦å­˜åœ¨
  if (!groups[groupId]) {
    alert('è¯¥ç¾¤ç»„ä¸å­˜åœ¨æˆ–å·²è¢«è§£æ•£');
    return;
  }

  // æ£€æŸ¥æ˜¯å¦å·²åœ¨ç¾¤ç»„ä¸­
  if (groups[groupId].members.includes(currentPhone)) {
    alert('ä½ å·²åœ¨è¯¥ç¾¤ç»„ä¸­');
    return;
  }

  // æ·»åŠ åˆ°ç¾¤ç»„æˆå‘˜
  groups[groupId].members.push(currentPhone);

  // æ·»åŠ åˆ°å½“å‰ç”¨æˆ·çš„ç¾¤ç»„åˆ—è¡¨
  if (!users[currentPhone].groups) users[currentPhone].groups = [];
  users[currentPhone].groups.push(groupId);

  // ä¿å­˜ä¿®æ”¹
  setStorage(STORAGE_KEYS.groups, groups);
  setStorage(STORAGE_KEYS.users, users);

  // åˆ·æ–°ç¾¤ç»„åˆ—è¡¨å¹¶æç¤º
  renderGroups();
  pushNotification(`å·²åŠ å…¥ç¾¤ç»„ï¼š${groups[groupId].name}`);
  alert(`æˆåŠŸåŠ å…¥ç¾¤ç»„ï¼š${groups[groupId].name}`);
}

/* ===================== é€šè¯è®°å½• ===================== */
function renderCallHistory() {
  const ul = document.getElementById('callHistory');
  ul.innerHTML = '';
  const calls = getStorage(STORAGE_KEYS.calls);
  const users = getStorage(STORAGE_KEYS.users);

  // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ—¶é—´å€’åºæ’åº
  const callList = Object.values(calls)
    .sort((a, b) => b.time - a.time)
    .slice(0, 10); // åªæ˜¾ç¤ºæœ€è¿‘10æ¡é€šè¯

  callList.forEach(call => {
    const li = document.createElement('li');
    const callerName = users[call.target]?.name || call.target;
    let callTypeText = '';
    let callTypeColor = '';

    switch (call.type) {
      case 'in':
        callTypeText = 'å·²æ¥æ¥ç”µ';
        callTypeColor = '#2ecc71';
        break;
      case 'out':
        callTypeText = 'å‘¼å‡ºç”µè¯';
        callTypeColor = '#3498db';
        break;
      case 'missed':
        callTypeText = 'æœªæ¥æ¥ç”µ';
        callTypeColor = '#e74c3c';
        break;
    }

    li.innerHTML = `
      <div>
        <span>${callerName}</span><br>
        <small style="font-size:10px;color:#666">${formatTime(call.time)} Â· ${callTypeText} Â· ${formatDuration(call.duration)}</small>
      </div>
      <button onclick="callBack('${call.target}')" style="padding:4px 8px;font-size:12px;">å›æ‹¨</button>
    `;
    li.querySelector('span').style.color = callTypeColor;
    ul.appendChild(li);
  });

  // è‹¥æ— é€šè¯è®°å½•
  if (callList.length === 0) {
    const li = document.createElement('li');
    li.textContent = 'æš‚æ— é€šè¯è®°å½•';
    li.style.textAlign = 'center';
    li.style.color = '#999';
    ul.appendChild(li);
  }
}

// å›æ‹¨åŠŸèƒ½
function callBack(phone) {
  document.getElementById('dialNumber').value = phone;
  makeCall();
}

/* ===================== é€šçŸ¥åŠŸèƒ½ ===================== */
function pushNotification(body) {
  if (Notification.permission === 'granted') {
    new Notification('å¤§å‡‰å›½äº‘é€šä¿¡', {
      body,
      icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMzQ5OGRiIiBkPSJNMzg0IDM2OEgzMjBDMzA3Ljk1OCAzNjggMzAwIDM3NS45NTggMzAwIDM4OFY0NDhjMCAxMi4wNDIgNy45NTggMjAgMjAgMjBoODBjMTIuMDQyIDAgMjAtNy45NTggMjAtMjBWMzg4YzAtMTIuMDQyLTcuOTU4LTIwLTIwLTIweiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0yNTYgMTkyYy0yNC44MTQgMC00NSAyMC4xODY0LTQ1IDQ1czIwLjE4NjQgNDUgNDUgNDUgNDUtNTAuMTg2NCA0NS00NXMyMC4xODY0LTQ1LTQ1LTQ1ek0yMjQgNDAwYzAtMTEuMDQyIDcuOTU4LTIwIDIwLTIwaDQxLjk5OTZjMTIuMDQyIDAgMjAgNy45NTggMjAgMjB2LTQ4Yy0xMi4wNDIgMC0yMC03Ljk1OC0yMC0yMHYtMjQuMDAwMWMyMi4wOTEtMTEuOTU4OCA0MC0zNC4wNDE5IDQwLTU5Ljk5OTl6bS0xNi0xMjh2LTI0YzAgLTExLjA0MiA3Ljk1OC0yMCAyMC0yMGg0OGMxMi4wNDIgMCAyMCA3Ljk1OCAyMCAyMHYyNGMwIDExLjA0Mi03Ljk1OCAyMC0yMCAyMGgtNDhjLTExLjA0MiAwLTIwLTcuOTU4LTIwLTIweiIvPjwvc3ZnPg=='
    });
  }
}

/* ===================== å¤„ç†çŸ­ä¿¡ç›¸å…³WebRTCä¿¡ä»¤ ===================== */
// æ‰©å±•ä¿¡ä»¤å¤„ç†é€»è¾‘ï¼ˆåœ¨åŸæœ‰handleWebrtcSignalå‡½æ•°åæ·»åŠ ï¼‰
function handleWebrtcSignal(signalData) {
  const { from: callerPhone, signal } = signalData;
  const { type, sdp, candidate } = signal;

  // å¿½ç•¥è‡ªå·±å‘é€çš„ä¿¡ä»¤
  if (callerPhone === currentUser.phone) return;

  switch (type) {
    case 'offer':
      handleIncomingCall(callerPhone, sdp);
      break;
    case 'answer':
      handleAnswer(callerPhone, sdp);
      break;
    case 'candidate':
      handleCandidate(callerPhone, candidate);
      break;
    case 'hangup':
      handleHangup(callerPhone);
      break;
    // æ–°å¢çŸ­ä¿¡ç›¸å…³ä¿¡ä»¤å¤„ç†
    case 'sms-offer':
      handleSmsOffer(callerPhone, sdp);
      break;
    case 'sms-candidate':
      handleSmsCandidate(callerPhone, candidate);
      break;
    default:
      break;
  }
}

// å¤„ç†çŸ­ä¿¡è¿æ¥offer
async function handleSmsOffer(fromPhone, sdp) {
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  });
  rtcConnections[`sms-${fromPhone}`] = pc;

  // ç›‘å¬æ•°æ®é€šé“
  pc.ondatachannel = (e) => {
    initDataChannel(e.channel, fromPhone);
    // å‘é€ç¦»çº¿çŸ­ä¿¡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    sendOfflineSms(fromPhone, e.channel);
  };

  // ç›‘å¬ICEå€™é€‰
  pc.onicecandidate = e => {
    if (e.candidate) {
      sendWebrtcSignal(fromPhone, { type: 'sms-candidate', candidate: e.candidate.toJSON() });
    }
  };

  // è®¾ç½®è¿œç¨‹æè¿°å¹¶å‘é€answer
  await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  sendWebrtcSignal(fromPhone, { type: 'sms-answer', sdp: answer.sdp });
}

// å¤„ç†çŸ­ä¿¡è¿æ¥ICEå€™é€‰
function handleSmsCandidate(fromPhone, candidate) {
  const pc = rtcConnections[`sms-${fromPhone}`];
  if (pc) {
    pc.addIceCandidate(new RTCIceCandidate(candidate))
      .catch(err => console.error('çŸ­ä¿¡è¿æ¥æ·»åŠ ICEå€™é€‰å¤±è´¥ï¼š', err));
  }
}

// å‘é€ç¦»çº¿çŸ­ä¿¡
function sendOfflineSms(targetPhone, dc) {
  const offlineSms = getStorage('dl_offline_sms');
  const smsList = offlineSms[targetPhone] || [];
  if (smsList.length === 0) return;

  // ç¡®ä¿æ•°æ®é€šé“å·²æ‰“å¼€
  const send = () => {
    if (dc.readyState === 'open') {
      smsList.forEach(sms => dc.send(JSON.stringify(sms)));
      // æ¸…ç©ºç¦»çº¿çŸ­ä¿¡
      delete offlineSms[targetPhone];
      setStorage('dl_offline_sms', offlineSms);
    } else {
      setTimeout(send, 100);
    }
  };

  send();
}

/* ===================== é€€å‡ºåŠŸèƒ½ ===================== */
function logout() {
  // æ ‡è®°å½“å‰ç”¨æˆ·ç¦»çº¿
  const users = getStorage(STORAGE_KEYS.users);
  if (users[currentUser.phone]) {
    users[currentUser.phone].online = false;
    users[currentUser.phone].lastOnline = Date.now();
    setStorage(STORAGE_KEYS.users, users);
  }

  // å…³é—­æ‰€æœ‰è¿æ¥å’Œæµ
  if (currentCall) endCall();
  Object.values(rtcConnections).forEach(pc => pc.close());
  if (localAudioStream) {
    localAudioStream.getTracks().forEach(track => track.stop());
  }

  // æ¸…é™¤å½“å‰ç”¨æˆ·ç¼“å­˜
  localStorage.removeItem(STORAGE_KEYS.currentUser);
  location.href = './index.html';
}

/* ===================== åˆå§‹åŒ–ç¦»çº¿çŸ­ä¿¡å¤„ç† ===================== */
(function initOfflineSms() {
  const offlineSms = getStorage('dl_offline_sms');
  const myOfflineSms = offlineSms[currentUser.phone] || [];
  if (myOfflineSms.length === 0) return;

  // å¤„ç†ç¦»çº¿çŸ­ä¿¡
  const smsList = getStorage(STORAGE_KEYS.sms);
  myOfflineSms.forEach(sms => {
    smsList.push({
      from: sms.from,
      to: currentUser.phone,
      body: sms.body,
      time: sms.time,
      type: sms.type === 'group-sms' ? 'group' : 'private'
    });
  });

  // æ¸…ç©ºç¦»çº¿çŸ­ä¿¡å¹¶ä¿å­˜
  delete offlineSms[currentUser.phone];
  setStorage('dl_offline_sms', offlineSms);
  setStorage(STORAGE_KEYS.sms, smsList);

  // åˆ·æ–°çŸ­ä¿¡åˆ—è¡¨å¹¶æç¤º
  if (document.getElementById('smsPage').classList.contains('active')) {
    renderSms();
  }
  pushNotification(`æ”¶åˆ°${myOfflineSms.length}æ¡ç¦»çº¿çŸ­ä¿¡`);
})();
</script>
</body>
</html>
