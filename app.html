<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¤§å‡‰å›½äº‘é€šä¿¡</title>
<meta name="theme-color" content="#004bbb">
<style>
:root{--main:#004bbb;--bg:#f4f4f9}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;background:var(--bg)}
header{background:var(--main);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
#screen{max-width:600px;margin:0 auto;background:#fff;min-height:100vh;display:flex;flex-direction:column}
#nav{display:flex;border-bottom:1px solid #ddd}
#nav button{flex:1;padding:10px;border:none;background:#fff;cursor:pointer;transition:.2s}
#nav button.active{background:var(--main);color:#fff}
.page{display:none;padding:16px;flex:1}
.page.active{display:block}
input,textarea,select{width:100%;padding:8px;margin:6px 0;box-sizing:border-box;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;border:none;border-radius:4px;background:var(--main);color:#fff;cursor:pointer}
button:disabled{background:#aaa}
.call-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.call-pad button{padding:18px;font-size:20px}
#callStatus{font-size:18px;margin:10px 0}
#msgList{max-height:40vh;overflow:auto;border:1px solid #ddd;padding:6px;border-radius:4px;background:#fafafa}
.msg{margin:4px 0;padding:4px;border-radius:4px;max-width:80%;word-wrap:break-word}.msg.me{text-align:right;margin-left:auto;background:#e3f2fd}.msg.other{margin-right:auto;background:#f5f5f5}
.group-invite{background:#ffe7ba;padding:6px;border-radius:4px;margin:4px 0}
#phoneList,#groupList,#callHistory{list-style:none;padding:0}
#phoneList li,#groupList li,#callHistory li{background:#f9f9f9;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
/* é€šè¯å¼¹çª— */
.call-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;z-index:999}
.call-modal.hidden{display:none}
.call-controls{display:flex;gap:20px;margin-top:40px}
.call-controls button{width:60px;height:60px;border-radius:50%;font-size:20px;display:flex;align-items:center;justify-content:center}
.call-controls button.danger{background:#e74c3c}
/* å½’å±åœ°æ˜¾ç¤ºæ ·å¼ä¼˜åŒ– */
#areaDisplay{font-size:14px;color:#333;margin:4px 0;padding:6px;background:#f0f7ff;border-radius:4px;border-left:3px solid var(--main)}
</style>
</head>
<body>
<div id="screen">
  <header>
    <span>ğŸ“ å¤§å‡‰å›½äº‘é€šä¿¡</span>
    <span id="userInfo"></span>
    <button onclick="logout()" style="padding:4px 8px;font-size:14px;">é€€å‡º</button>
  </header>

  <nav id="nav">
    <button class="navBtn active" data-page="dialPage">æ‹¨å·</button>
    <button class="navBtn" data-page="smsPage">çŸ­ä¿¡</button>
    <button class="navBtn" data-page="groupPage">ç¾¤ç»„</button>
    <button onclick="location.href='./gen.html'">ç”Ÿå·</button>
  </nav>

  <!-- æ‹¨å· -->
  <section id="dialPage" class="page active">
    <h3>æ‹¨å·ç›˜</h3>
    <input id="dialNumber" placeholder="ä¾‹ï¼š+3-000-123-45678" oninput="showArea()">
    <!-- å®Œæ•´å½’å±åœ°æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="areaDisplay">
      <strong>å½’å±åœ°ï¼š</strong>æœªè¯†åˆ«ï¼ˆè¯·è¾“å…¥å®Œæ•´åŒºå·ï¼‰
    </div>
    <div class="call-pad">
      <button onclick="press('1')">1</button><button onclick="press('2')">2</button><button onclick="press('3')">3</button>
      <button onclick="press('4')">4</button><button onclick="press('5')">5</button><button onclick="press('6')">6</button>
      <button onclick="press('7')">7</button><button onclick="press('8')">8</button><button onclick="press('9')">9</button>
      <button onclick="press('*')">*</button><button onclick="press('0')">0</button><button onclick="press('#')">#</button>
      <button onclick="press('-')">-</button><button onclick="delLast()" style="grid-column:2">âŒ«</button><button onclick="clearInput()">æ¸…ç©º</button>
    </div>
    <button onclick="makeCall()">ğŸ“ æ‹¨æ‰“</button>
    <div id="callStatus">å°±ç»ª</div>
    <h4>æœ€è¿‘é€šè¯</h4>
    <ul id="callHistory"></ul>
  </section>

  <!-- çŸ­ä¿¡ -->
  <section id="smsPage" class="page">
    <h3>æ”¶å‘çŸ­ä¿¡</h3>
    <input id="smsTo" placeholder="æ¥æ”¶æ–¹å·ç /ç¾¤ç»„IDï¼ˆç¾¤ç»„ä»¥gå¼€å¤´ï¼‰">
    <textarea id="smsBody" rows="3" placeholder="çŸ­ä¿¡å†…å®¹" maxlength="500"></textarea>
    <button onclick="sendSms()">å‘é€</button>
    <h4>èŠå¤©è®°å½•</h4>
    <div id="msgList"></div>
  </section>

  <!-- ç¾¤ç»„ -->
  <section id="groupPage" class="page">
    <h3>ç¾¤ç»„</h3>
    <input id="groupName" placeholder="æ–°ç¾¤ç»„åç§°" maxlength="30">
    <button onclick="createGroup()">åˆ›å»ºç¾¤ç»„</button>
    <h4>æˆ‘çš„ç¾¤ç»„</h4>
    <ul id="groupList"></ul>
    <h4>é‚€è¯·é“¾æ¥ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰</h4>
    <input id="inviteLink" readonly>
    <button onclick="joinFromLink()">é€šè¿‡é“¾æ¥åŠ å…¥</button>
  </section>
</div>

<!-- é€šè¯å¼¹çª— -->
<div id="callModal" class="call-modal hidden">
  <h2 id="callerInfo">æ­£åœ¨é€šè¯ä¸­...</h2>
  <div class="call-controls">
    <button class="danger" onclick="endCall()">âŒ</button>
    <button onclick="answerCall()" id="answerBtn" style="background:#2ecc71">ğŸ“</button>
  </div>
</div>

<script>
/* ===================== å¤§å‡‰å›½å®Œæ•´åœ°åŒºæ•°æ®ï¼ˆæ¥è‡ªå·ç ç”Ÿæˆå™¨ï¼‰ ===================== */
const fixedCodes={
    "æ±Ÿä¸­é“":{
        "å¿ å·åºœ":{"å—åŸå¿":"260-001","åŒ—åŸå¿":"260-002"},
        "è¾¹åŸåºœ":{"è¾¹å—å¿":"260-003","è¾¹åŒ—å¿":"260-004"},
        "å››éƒ¨åºœ":{"å››ä¸€éƒ¨":"260-005","å››äºŒéƒ¨":"260-006"},
        "ä¸­é˜´åºœ":{"_central":"260-007"}
    },
    "å·é˜³é“":{
        "ä¸­é˜³åºœ":{"_central":"040-001"},
        "å‘¨åº·åºœ":{"_central":"040-002"},
        "ç¿Šå·åºœ":{"_central":"040-003"}
    },
    "å®šå·é“":{
        "é¡ºåº†åºœ":{"_central":"030-001"},
        "å†å·åºœ":{"_central":"030-002"},
        "å®ååºœ":{"_central":"030-003"},
        "æ³½å·åºœ":{"_central":"030-004"},
        "å°é™µåºœ":{"_central":"030-005"}
    },
    "äº¬ç•¿é“":{
        "ä¼šå·åºœ":{"å—ä¼šå¿":"020-001","é˜³å…³å¿":"020-002"},
        "ä¸œååºœ":{"_central":"020-003"},
        "ä¸œç‰åºœ":{"_central":"020-004"},
        "åœ£å¤©å…ƒå ¡":{"_central":"020-005"},
        "åœ£é¢œå®‡ç¿”å ¡":{"_central":"020-006"}
    },
    "è¥¿ç‰é“":{
        "å±±å—åºœ":{"_central":"050-001"},
        "ç®•å°¾åºœ":{"_central":"050-002"},
        "å·å—æ—åŒº":{"_central":"050-003"}
    },
    "å˜‰æ­é“":{
        "ä½™å·åºœ":{"_central":"060-001"},
        "æ±Ÿå—åºœ":{"æ²æ±Ÿå…¬ç¤¾":"060-002","æ±Ÿå³å…¬ç¤¾":"060-003"}
    },
    "å®ªå®½é“":{
        "é¡ºéƒ½åºœ":{"ä¸­éƒ½å…¬ç¤¾":"070-001","å¤©ä¸­å¿":"070-002","æ±Ÿä¸œå¿":"070-003"},
        "ç¥ä¸­åºœ":{"_central":"070-004"},
        "æ˜å®‰åºœ":{"_central":"070-005"}
    },
    "å¹³åŸé“":{
        "æˆé‚‘åºœ":{"_central":"080-001"},
        "å‡½å·åºœ":{"_central":"080-002"},
        "ä¸­æ—¸åºœ":{"_central":"080-003"}
    },
    "åºç˜é“":{
        "åˆæ±Ÿåºœ":{"_central":"090-001"},
        "æ·é˜´åºœ":{"_central":"090-002"},
        "é›åº†åºœ":{"_central":"090-003"}
    },
    "æœ”å£é“":{
        "ä¸­æŠ¤åºœ":{"_central":"100-001"},
        "è¥¿å’Œåºœ":{"_central":"100-002"}
    },
    "å¹¿åŒ—é“":{
        "å¹¿å®åºœ":{"_central":"110-001"},
        "ä¹Ÿå·åºœ":{"_central":"110-002"},
        "å…‰ååºœ":{"_central":"110-003"},
        "ä¸‡æ± åºœ":{"å³¡é—´å¿":"110-004","è¥¿åœ°å¿":"110-005","å—æ± å¿":"110-006","ä¸œæ¶Ÿå¿":"110-007"},
        "é‚‘å·åºœ":{"_central":"110-008"},
        "æœ›å·åºœ":{"_central":"110-009"},
        "æ´²è§’åºœ":{"_central":"110-010"}
    },
    "ä¸Šå†é»é“":{
        "å£è¾¹åºœ":{"_central":"120-001"},
        "åº†å»åºœ":{"_central":"120-002"},
        "æµ·é˜²æ¸¯åºœ":{"_central":"120-003"},
        "è¥¿å·åºœ":{"_central":"120-004"},
        "å¾åº†å…ƒåºœ":{"_central":"120-005"}
    },
    "çœŸå’Œé“":{
        "æµ·å—åºœ":{"_central":"130-001"}
    },
    "ç¦¹è¿œé“":{
        "ä¸œå®åºœ":{"_central":"140-001"},
        "å¹¿å¹³åºœ":{"_central":"140-002"},
        "æ–‡æ­£åºœ":{"_central":"140-003"},
        "ç¦¹æ’åºœ":{"_central":"140-004"},
        "æ™¨å·åºœ":{"_central":"140-005"},
        "æ¸…è¿œåºœ":{"_central":"140-006"},
        "ä¸´å°‘åºœ":{"_central":"140-007"},
        "å¤¹å·åºœ":{"_central":"140-008"}
    },
    "æ™¯é˜³é“":{
        "å®«é˜³åºœ":{"_central":"150-001"},
        "æ˜ååºœ":{"_central":"150-002"},
        "æ™–è‰¯åºœ":{"_central":"150-003"}
    },
    "ä¹å‡‰é“":{
        "é«˜å‡‰åºœ":{"_central":"160-001"},
        "å¹³é¢–åºœ":{"_central":"160-002"},
        "æ°‘æ²»åºœ":{"æ°‘å’Œå¿":"160-003","é½æ²»å¿":"160-004"},
        "ä¸­ååºœ":{"_central":"160-005"},
        "ä¸‹å‡‰åºœ":{"_central":"160-006"},
        "å±±å·åºœ":{"_central":"160-007"}
    },
    "å®‰è¯¸çœ":{
        "å‹å¼€åºœ":{"é’¦å­œå¿":"170-001","ä¼—å®‰åŒº":"170-002"},
        "è¶Šéƒ½åºœ":{"_central":"170-003"},
        "æ­£å¤ªåºœ":{"_central":"170-004"},
        "é‚‘å·åºœ":{"_central":"170-005"}
    },
    "å¾·æ„å¿—ç½—æ›¼çœ":{
        "åœ£æŸæ—å·":{"_central":"180-001"},
        "å„æ–¯æ›¼å¤§åŒº":{"_central":"180-002"},
        "å“ˆå¾—é‡Œå¥¥å¤§åŒº":{"_central":"180-003"}
    },
    "å·´è¨å…‹çœ":{
        "å“ˆæ‹‰è‹å–‡åºœ":{"_central":"190-001"},
        "å“ˆå‰Œæ—ç‰¹åºœ":{"_central":"190-002"},
        "è’™è½¦åˆ©":{"_central":"190-003"},
        "å—é¢æœµå„¿æˆˆå£":{"_central":"190-004"},
        "å·´è¨èµ›æ‰˜":{"_central":"190-005"},
        "ä¹Œå¡ææ–¯":{"_central":"190-006"},
        "åæ¢…æ‹‰":{"_central":"190-007"},
        "æ—è¾¹":{"_central":"190-008"},
        "æ•–å ‚":{"_central":"190-009"},
        "å‘¼å°”æ—é‚£ç›Ÿ":{"_central":"190-010"},
        "ç‘Ÿæ—¥ä¸¹":{"_central":"190-011"},
        "çªå¥åˆ©äºšæ–¯å…‹":{"_central":"190-012"},
        "ä¹Œå¯Ÿç±³å°”å°ç§‘åˆ—äºšå¸ƒå¡æ‹‰ç»´æ–¯å…‹":{"_central":"190-013"},
        "è¿¦ä¼ç½—":{"_central":"190-014"}
    },
    "å—æè¾¹åŒºéƒ½æŠ¤":{
        "ä»™éšéƒ½åºœ":{"_central":"200-001"},
        "çœŸåŒ–éƒ¨":{"_central":"200-002"},
        "å¾·åŒ–éƒ¨":{"_central":"200-003"},
        "å¦™ä¸Šé½é“éƒ¨":{"_central":"200-004"},
        "æ¸…ä¸€éƒ¨":{"_central":"200-005"},
        "è‰²åˆ—é‚£éƒ¨":{"_central":"200-006"},
        "å…‰ä¸Šéƒ¨":{"_central":"200-007"},
        "éœå°”æµ©æ—éƒ¨":{"_central":"200-008"}
    },
    "å¦‚æ„è·¯":{
        "å¦‚æ„åŸ":{"_central":"210-001"},
        "å®è‡ªåœ¨":{"_central":"210-002"},
        "é‡Šé‚£è¿¦èˆ":{"_central":"210-003"},
        "æä¹åŸ":{"_central":"210-004"},
        "å¦‚æ„å®ç‹":{"_central":"210-005"},
        "æ¯—ç‰ç’ƒæ³¢ç½—å¥ˆ":{"_central":"210-006"},
        "æ‘©è¯ƒè‹ç½—æè¯ƒ":{"_central":"210-007"},
        "æ³¢æƒ¹é‚£èˆé‚£æ":{"_central":"210-008"},
        "ç¦åŸ":{"_central":"210-009"},
        "å‡€å":{"_central":"210-010"},
        "æ™´å‡‰":{"_central":"210-011"},
        "äº‘ç›¸":{"_central":"210-012"},
        "æ‘©å°¼":{"_central":"210
-013"},
        "å‰åº†":{"_central":"210-014"},
        "å…‰åŒ–":{"_central":"210-015"},
        "æ—ƒæª€æµ·":{"_central":"210-016"},
        "åœ†è§‰":{"_central":"210-017"},
        "æ¸…æ³°":{"_central":"210-018"},
        "ç©ºç›¸":{"_central":"210-019"}
    },
    "ç¢§è‰²æ¬¢å–œè·¯":{
        "æœªåˆ—å…·ä½“åºœ":{"_central":"220-001"}
    },
    "äº¤æ¸¯åºœ":{
        "æ»Ÿé˜³å¿":{"_central":"230-001"},
        "ä¸´æ¸šå¿":{"_central":"230-002"},
        "æ²™æ¹¾å˜´åŒº":{"_central":"230-003"},
        "é¥å®‰å…¬ç¤¾":{"_central":"230-004"}
    },
    "çƒ­ä¹…åºœ":{
        "ä¼Šå¥ˆå¿":{"_central":"240-001"}
    },
    "è¥„å·åºœ":{
        "åŸŸå—å¿":{"_central":"250-001"}
    },
    "å‡¡å¤šåºœ":{
        "åœ£äº¬å…¬ç¤¾":{"é”¦å…‰è¡—é“":"010-001"},
        "å¤§éƒ½å…¬ç¤¾":{"ä¸­äº¤è¡—é“":"010-002"},
        "éº¦å’Œç»æµå¼€å‘åŒº":{"_central":"010-003"},
        "çµæ³½å¿":{"ç™½æ˜­ä¹¡":"010-004"},
        "æ™¯æ°‘å¿":{"_central":"010-005"},
        "å±‹æ¡“å¿":{"å—æ¡“ä¹¡":"010-006"},
        "è¥¿éƒŠæ–°åŒº":{"_central":"010-007"},
        "èƒœå®‰æ–°åŒº":{"_central":"010-008"}
    },
    "ä¾åˆ©ä¼äº¦çœ":{
        "å¸ƒå“ˆæ‹‰åºœ":{"_central":"270-001"},
        "å„é‡Œäºšé‚£":{"_central":"270-002"}
    },
    "é˜¿åˆ—å¤«æ³°å·":{
        "é˜¿åˆ—å¤«æ³°éƒ¡":{"_central":"280-001"},
        "ä¸æ—¥é‚£æ¯”å°”å¤§åŒº":{"_central":"280-002"},
        "å¥‘è«è¯ƒè€¶å¤«å¤§åŒº":{"_central":"280-003"},
        "å¡é›…æ ¼ç³å ¡å¤§åŒº":{"_central":"280-004"}
    },
    "å‹è°Šé“":{
        "æ³•å…°ç‘":{"_central":"290-001"},
        "åº·ç‘":{"_central":"290-002"},
        "äº‘å®é»›ç»´è¯—":{"_central":"290-003"},
        "æ³¢å…‹å¸ƒæ´›å…‹":{"_central":"290-004"},
        "å¤šæƒ¹åŸƒè’™":{"_central":"290-005"}
    },
    "é˜¿åº•èˆåˆ©é“":{
        "æ—¥åº“å‰æ¶…é’¦":{"_central":"300-001"},
        "ä¸Šåº·":{"_central":"300-002"},
        "è¥„å˜‰æªç‹":{"_central":"300-003"},
        "ä¹Œå°”é‚£":{"_central":"300-004"},
        "æ‘©è¯ƒæ…•ææ–¯":{"_central":"300-005"}
    },
    "æ™®æ‹‰ç‰¹å°”åé‚¦":{
        "é˜¿ç“¦çº³åŸº":{"_central":"310-001"}
    },
    "ç›æè«å°”åœ°åŒº":{
        "ä¹Œé‡Œè€¶å…¹":{"_central":"320-001"},
        "ä¹Œå¯Ÿä¸æ–¯":{"_central":"320-002"},
        "ä¹Œå¯Ÿèµ›å¸ƒæ–¯â€¢æ¯”è€¶è¾“è¿¦é‚£":{"_central":"320-003"},
        "æ‘©è¯ƒè¨æ—é‚£":{"_central":"320-004"},
        "å¸ƒæ´›å…‹":{"_central":"320-005"}
    },
    "å¯†åˆ©è€¶è²å°”è¾¾çœ":{
        "é‡Œå¡ç‘äºš":{"_central":"330-001"},
        "ä¼Šæ³½å…‹é‡Œæ–¯æé‚£":{"_central":"330-002"}
    },
    "å°”å–€å¸ƒå°¼åˆ©å…‹å·":{
        "è±è¯º":{"_central":"340-001"},
        "æ°è¥¿å¡åˆ©äºš":{"_central":"340-002"}
    },
    "å›½ä¸Šé“":{
        "å›½ä¸Š":{"_central":"350-001"}
    },
    "å’Œè°é“":{
        "å›¾å“ˆè¾¾":{"_central":"360-001"}
    },
    "åº“äºšæ‹‰çœ":{
        "æ©è´¡å¤š":{"_central":"370-001"}
    },
    "ç“¦åŠ é©¬å°”è¥¿å—ç‰¹åŒº":{
        "è¨èµ«ç‰¹":{"_central":"380-001"},
        "ç©†å·´æ‰å“ˆå§†":{"_central":"380-002"},
        "é”¡å°”ç“¦":{"_central":"380-003"},
        "æ³½åŠ ä¸‡":{"_central":"380-004"},
        "å¡ä¼Šå›¾å§†":{"_central":"380-005"},
        "é˜¿å·´å°”å¡":{"_central":"380-006"}
    },
    "å·¥ä¸šé“":{
        "å·¥ä¸šåŸ":{"_central":"390-001"},
        "å¤§å·¥åºœ":{"_central":"390-002"},
        "ç”Ÿç‰©å·¥ç¨‹åŸ":{"_central":"390-003"},
        "æ—¥åŒ–åŸ":{"_central":"390-004"},
        "åŒ–å­¦åŸ":{"_central":"390-005"},
        "ç‰©ç†åŸ":{"_central":"390-006"}
    },
    "ç‡•é˜³é“":{
        "è§£æ”¾åºœ":{"_central":"400-001"},
        "èµ¤å¡”åºœ":{"_central":"400-002"}
    },
    "åŒ—æµ·çœ":{
        "æ–¯å¤§æ—æ ¼å‹’æ—äºš":{"_central":"410-001"},
        "å…‹äºšä¿åŠ æ¸¯":{"_central":"410-002"},
        "å·´æä¹Œ":{"_central":"410-003"},
        "æ˜åˆ©å¯Ÿ":{"_central":"410-004"}
    },
    "ä¸œæ–¹é“":{
        "å¤§åº­åºœ":{"_central":"420-001"},
        "æå·åºœ":{"_central":"420-002"},
        "é™çµåºœ":{"_central":"420-003"},
        "èˆ¬è‹¥åºœ":{"_central":"420-004"}
    },
    "å®‡è”ç‰¹åŒº":{
        "åœ£ä¸‡å¾·":{"_central":"430-001"}
    },
    "ç€›å‡°ç‰¹åˆ«è¡Œæ”¿åŒº":{
        "é¹°å’€å¸‚":{"_central":"440-001"},
        "æ²™é“å¸‚":{"_central":"440-002"},
        "é¥¶æ±€æ¢å¸‚":{"_central":"440-003"},
        "åŸä¸Šå¸‚":{"_central":"440-004"},
        "éº“å·å¸‚":{"_central":"440-005"}
    },
    "æ´¢ç”¸é“":{
        "ä¼šå—åºœ":{"_central":"450-001"},
        "æ±Ÿå£åºœ":{"ä¹‚å®å¿":"450-002","æ±ŸåŒ—å¿":"450-003","æ´¢å·¦å¿":"450-004"},
        "é«˜ç”¸åºœ":{"_central":"450-005"}
    },
    "å·´å¨œé“":{
        "å·´å¨œåˆ©äºš":{"_central":"460-001"},
        "æ¡‘æ ¼è€¶":{"_central":"460-002"},
        "å¡å°¼å¾·":{"_central":"460-003"},
        "é›…é›…äºšå¥‡":{"_central":"460-004"},
        "è¨é›…è€¶":{"_central":"460-005"},
        "æè‹":{"_central":"460-006"},
        "å¡å¨œå·´å¤š":{"_central":"460-007"}
    },
    "é•¿åº†é“":{
        "åœ£é‡‘åºœ":{"_central":"470-001"},
        "æ›¹é˜³åºœ":{"åº†é˜³å¿":"470-002"},
        "æ·±åŸåºœ":{"ç”Ÿç±³å¿":"470-003","æ˜Ÿå¯åŒº":"470-004"},
        "å¾¡å·åºœ":{"_central":"470-005"}
    },
    "å…³å†…é“":{
        "å…´åº†åºœ":{"_central":"480-001"}
    },
    "æ¢¦å¹»é“":{
        "è”å’Œåºœ":{"å¹»å·å¿":"490-001"}
    },
    "æµ·è¥¿çœ":{
        "è¥¿æµ·å£":{"_central":"500-001"},
        "ç‰¦åŸ":{"_central":"500-002"},
        "è¾¹æµ·":{"_central":"500-003"},
        "è¥¿å±±":{"_central":"500-004"},
        "æè¥¿":{"è¥¿åŸŸè¾¹":"500-005"}
    },
    "äº¬ååºœ":{
        "åŒ—åœ°å¿":{"äºä¹¡":"510-001"},
        "è§‚é˜³å†›äº‹åŒº":{"_central":"510-002"},
        "æ±Ÿè¾¹å¿":{"_central":"510-003"},
        "æˆ·åå…¬ç¤¾":{"_central":"510-004"},
        "åº†é˜´å¿":{"_central":"510-005"},
        "é›æ³ åŒº":{"_central":"510-006"},
        "é™µæ˜å…¬ç¤¾":{"_central":"510-007"},
        "æ¹–è¥¿åŒº":{"ä¸´ä»“é•‡":"510-008"}
    },
    "ä¸Šè‹ç»´åŸƒçœ":{
        "å¸ƒå°”ä»€ç»´æ ¼å‹’":{"_central":"520-001"}
    },
    "æ¢µç½‘æ•™åŒº":{
        "æ¯—é˜‡è€¶åŸ":{"_central":"530-001"},
        "éº¦è¿ªä»€å¸ƒ":{"_central":"530-002"},
        "é“ä¸Š":{"_central":"530-003"},
        "ä¼Šå°”é›…å…‹":{"_central":"530-004"}
    },
    "è‹ä¸¹çœ":{
        "ç“œå“ˆå›¾å§†è‹å°”åŠ ":{"_central":"540-001"}
    },
    "ä¸Šå’Œä¹é“":{
        "æ— æ˜åºœ":{"_central":"550-001"},
        "ä¸Šå…ƒåºœ":{"_central":"550-002"},
        "ä»“å—åºœ":{"æ»¨æ¹–å…¬ç¤¾":"550-003","æ¹–å—åŒº":"550-004","ä»“é˜´å¿":"550-005"}
    },
    "æ±ŸåŒ—é“":{
        "æ¯›æ³½ä¸œåºœ":{"_central":"560-001"},
        "ä¹Œç»´æ‹‰æ—¥å°¼ä¹Œå¯Ÿåˆ«åˆ—æ–¯å…‹":{"_central":"560-002"}
    },
    "è¥¿æ±Ÿé“":{
        "æ²‚æ˜Œåºœ":{"_central":"570-001"},
        "å’Œä¸œåºœ":{"_central":"570-002"}
    },
    "å¿…æ”¯åºœ":{
        "ä¹…å¼¯å¿":{"_central":"580-001"}
    },
    "æ¶§é—¨é“":{
        "å¿»æ˜¥åºœ":{"_central":"590-001"},
        "æ±Ÿé—´åºœ":{"_central":"590-002"}
    },
    "æ˜“å…³çœ":{
        "å…³ä¸­åºœ":{"_central":"600-001"},
        "è¥¿ä¼šåºœ":{"_central":"600-002"}
    },
    "æºŸå·è·¯":{
        "å†¥å±±åºœ":{"_central":"610-001"}
    },
    "å¤©ææ³•è·¯":{
        "æ˜æ­£åºœ":{"_central":"620-001"}
    }
};

/* ===================== å½’å±åœ°æŸ¥è¯¢å·¥å…·å‡½æ•° ===================== */
function getAreaCodeFromPhone(phone) {
    if (!phone.startsWith('+3')) return '';
    const match = phone.match(/\+3-(\d{3})-(\d{3})/);
    return match ? `${match[1]}-${match[2]}` : '';
}

function getFullArea(phone) {
    const targetCode = getAreaCodeFromPhone(phone);
    if (!targetCode) return 'æœªè¯†åˆ«å½’å±åœ°';

    for (const [dao, fuObj] of Object.entries(fixedCodes)) {
        for (const [fu, xianObj] of Object.entries(fuObj)) {
            for (const [xian, code] of Object.entries(xianObj)) {
                if (code === targetCode) {
                    const xianName = xian === '_central' ? 'ç›´è¾–åŒº' : xian;
                    return `${dao} > ${fu} > ${xianName}`;
                }
            }
        }
    }

    if (phone.startsWith('+3-000')) {
        return 'äº¬ç•¿é“ > å‡¡å¤šåºœ > åœ£äº¬å…¬ç¤¾ï¼ˆä¸­å¤®å·ç ï¼‰';
    }

    return 'æœªçŸ¥å½’å±åœ°';
}

/* ===================== æ ¸å¿ƒé…ç½® ===================== */
const STORAGE_KEYS = {
    currentUser: 'dl_currentUser',
    userPhoneMap: 'dl_userPhoneMap',
    users: 'dl_users',
    sms: 'dl_sms',
    calls: 'dl_calls',
    groups: 'dl_groups',
    webrtcSignals: 'dl_webrtc_signals'
};

/* ===================== å…¨å±€å˜é‡ ===================== */
let currentUser;
let rtcConnections = {};
let dataChannels = {};
let currentCall = null;
let localAudioStream = null;

/* ===================== å·¥å…·å‡½æ•° ===================== */
function getStorage(key) {
    try {
        return JSON.parse(localStorage.getItem(key) || '{}');
    } catch (e) {
        localStorage.removeItem(key);
        return {};
    }
}

function setStorage(key, data) {
    localStorage.setItem(key, JSON.stringify(data));
}

function formatTime(timestamp) {
    return new Date(timestamp).toLocaleString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function sendWebrtcSignal(targetPhone, signal) {
    const signals = getStorage(STORAGE_KEYS.webrtcSignals);
    if (!signals[targetPhone]) signals[targetPhone] = [];
    signals[targetPhone].push({ from: currentUser.phone, signal, time: Date.now() });
    setStorage(STORAGE_KEYS.webrtcSignals, signals);
}

function handleWebrtcSignal(signalData) {
    const { from: callerPhone, signal } = signalData;
    const { type, sdp, candidate } = signal;

    if (callerPhone === currentUser.phone) return;

    switch (type) {
        case 'offer':
            handleIncomingCall(callerPhone, sdp);
            break;
        case 'answer':
            handleAnswer(callerPhone, sdp);
            break;
        case 'candidate':
            handleCandidate(callerPhone, candidate);
            break;
        case 'hangup':
            handleHangup(callerPhone);
            break;
        case 'sms-offer':
            handleSmsOffer(callerPhone, sdp);
            break;
        case 'sms-candidate':
            handleSmsCandidate(callerPhone, candidate);
            break;
        default:
            break;
    }
}

function initDataChannel(dc, target) {
    dc.onopen = () => {
        console.log(`ä¸ ${target} çš„æ•°æ®é€šé“å·²æ‰“å¼€`);
        dataChannels[target] = dc;
    };

    dc.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'sms') {
            const smsList = getStorage(STORAGE_KEYS.sms);
            smsList.push({
                from: target,
                to: currentUser.phone,
                body: data.body,
                time: Date.now(),
                type: 'private'
            });
            setStorage(STORAGE_KEYS.sms, smsList);
            if (document.getElementById('smsPage').classList.contains('active')) {
                renderSms();
            }
            pushNotification(`æ–°çŸ­ä¿¡æ¥è‡ª ${target}`);
        } else if (data.type === 'group-sms') {
            const smsList = getStorage(STORAGE_KEYS.sms);
            smsList.push({
                from: data.from,
                to: data.groupId,
                body: data.body,
                time: Date.now(),
                type: 'group'
            });
            setStorage(STORAGE_KEYS.sms, smsList);
            if (document.getElementById('smsPage').classList.contains('active
)) {
                renderSms();
            }
            pushNotification(`æ–°ç¾¤æ¶ˆæ¯æ¥è‡ª ${data.groupName}`);
        }
    };

    dc.onclose = () => {
        console.log(`ä¸ ${target} çš„æ•°æ®é€šé“å·²å…³é—­`);
        delete dataChannels[target];
    };

    dc.onerror = (error) => {
        console.error(`æ•°æ®é€šé“é”™è¯¯: ${error}`);
        delete dataChannels[target];
    };
}

function pushNotification(title) {
    if (Notification.permission === 'granted') {
        new Notification(title);
    } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                new Notification(title);
            }
        });
    }
}

/* ===================== å½’å±åœ°æ˜¾ç¤ºå‡½æ•° ===================== */
function showArea() {
  const phone = document.getElementById('dialNumber').value.trim();
  const areaDisplay = document.getElementById('areaDisplay');
  
  if (phone.length >= 10) {
    const fullArea = getFullArea(phone);
    areaDisplay.innerHTML = `<strong>å½’å±åœ°ï¼š</strong>${fullArea}`;
  } else {
    areaDisplay.innerHTML = '<strong>å½’å±åœ°ï¼š</strong>æœªè¯†åˆ«ï¼ˆè¯·è¾“å…¥å®Œæ•´åŒºå·ï¼Œæ ¼å¼ï¼š+3-xxx-xxx-xxxxxxï¼‰';
  }
}

/* ===================== æ‹¨å·ç›˜å·¥å…·å‡½æ•° ===================== */
function press(key) {
  const input = document.getElementById('dialNumber');
  input.value += key;
  showArea();
}

function delLast() {
  const input = document.getElementById('dialNumber');
  input.value = input.value.slice(0, -1);
  showArea();
}

function clearInput() {
  document.getElementById('dialNumber').value = '';
  showArea();
}

/* ===================== é€šè¯ç›¸å…³å‡½æ•° ===================== */
async function initLocalAudio() {
    if (localAudioStream) return localAudioStream;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localAudioStream = stream;
        return stream;
    } catch (error) {
        console.error('è·å–éº¦å…‹é£æƒé™å¤±è´¥:', error);
        alert('é€šè¯åŠŸèƒ½éœ€è¦éº¦å…‹é£æƒé™ï¼Œè¯·å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£');
        return null;
    }
}

function createRtcConnection(targetPhone) {
    const pc = new RTCPeerConnection({
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
        ]
    });

    if (localAudioStream) {
        localAudioStream.getTracks().forEach(track => {
            pc.addTrack(track, localAudioStream);
        });
    }

    pc.ontrack = (e) => {
        const remoteAudio = document.createElement('audio');
        remoteAudio.srcObject = e.streams[0];
        remoteAudio.autoplay = true;
        remoteAudio.hidden = true;
        document.body.appendChild(remoteAudio);
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            sendWebrtcSignal(targetPhone, {
                type: 'candidate',
                candidate: e.candidate.toJSON()
            });
        }
    };

    pc.ondatachannel = (e) => {
        initDataChannel(e.channel, targetPhone);
    };

    pc.onconnectionstatechange = () => {
        console.log('è¿æ¥çŠ¶æ€:', pc.connectionState);
        if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
            handleHangup(targetPhone);
        }
    };

    return pc;
}

async function makeCall() {
    const targetPhone = document.getElementById('dialNumber').value.trim();
    if (!targetPhone || !targetPhone.startsWith('+3')) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤§å‡‰å›½ç”µè¯å·ç ï¼ˆä»¥+3å¼€å¤´ï¼‰');
        return;
    }

    if (targetPhone === currentUser.phone) {
        alert('ä¸èƒ½æ‹¨æ‰“è‡ªå·±çš„å·ç ');
        return;
    }

    const users = getStorage(STORAGE_KEYS.users);
    if (!Object.values(users).some(u => u.phone === targetPhone)) {
        if (!confirm('è¯¥å·ç æœªæ³¨å†Œï¼Œæ˜¯å¦ç»§ç»­æ‹¨æ‰“ï¼Ÿ')) {
            return;
        }
    }

    const stream = await initLocalAudio();
    if (!stream) return;

    currentCall = {
        target: targetPhone,
        isIncoming: false
    };

    const pc = createRtcConnection(targetPhone);
    rtcConnections[targetPhone] = pc;

    const dc = pc.createDataChannel('sms-channel');
    initDataChannel(dc, targetPhone);

    try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendWebrtcSignal(targetPhone, {
            type: 'offer',
            sdp: offer.toJSON()
        });

        document.getElementById('callModal').classList.remove('hidden');
        document.getElementById('callerInfo').textContent = `æ­£åœ¨æ‹¨æ‰“ ${targetPhone}`;
        document.getElementById('answerBtn').style.display = 'none';
    } catch (error) {
        console.error('åˆ›å»ºé€šè¯å¤±è´¥:', error);
        alert('åˆ›å»ºé€šè¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        pc.close();
        delete rtcConnections[targetPhone];
        currentCall = null;
    }
}

function handleIncomingCall(callerPhone, sdp) {
    if (currentCall) {
        sendWebrtcSignal(callerPhone, { type: 'hangup' });
        return;
    }

    currentCall = {
        target: callerPhone,
        isIncoming: true
    };

    const pc = createRtcConnection(callerPhone);
    rtcConnections[callerPhone] = pc;

    pc.setRemoteDescription(new RTCSessionDescription(sdp))
        .then(async () => {
            const stream = await initLocalAudio();
            if (!stream) {
                pc.close();
                delete rtcConnections[callerPhone];
                currentCall = null;
                sendWebrtcSignal(callerPhone, { type: 'hangup' });
                return;
            }

            document.getElementById('callModal').classList.remove('hidden');
            document.getElementById('callerInfo').textContent = `æ¥è‡ª ${callerPhone} çš„æ¥ç”µ`;
            document.getElementById('answerBtn').style.display = 'inline-flex';
        })
        .catch(error => {
            console.error('å¤„ç†æ¥ç”µå¤±è´¥:', error);
            pc.close();
            delete rtcConnections[callerPhone];
            currentCall = null;
        });
}

async function answerCall() {
    if (!currentCall || !currentCall.isIncoming) return;

    const { target: callerPhone } = currentCall;
    const pc = rtcConnections[callerPhone];
    if (!pc) return;

    try {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        sendWebrtcSignal(callerPhone, {
            type: 'answer',
            sdp: answer.toJSON()
        });

        document.getElementById('callerInfo').textContent = `æ­£åœ¨ä¸ ${callerPhone} é€šè¯`;
        document.getElementById('answerBtn').style.display = 'none';

        const calls = getStorage(STORAGE_KEYS.calls);
        calls.push({
            type: 'incoming',
            otherParty: callerPhone,
            time: Date.now(),
            duration: 0,
            status: 'answered'
        });
        setStorage(STORAGE_KEYS.calls, calls);
        renderCalls();
    } catch (error) {
        console.error('æ¥å¬é€šè¯å¤±è´¥:', error);
        alert('æ¥å¬é€šè¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        endCall();
    }
}

function handleAnswer(callerPhone, sdp) {
    const pc = rtcConnections[callerPhone];
    if (!pc) return;

    pc.setRemoteDescription(new RTCSessionDescription(sdp))
        .then(() => {
            document.getElementById('callerInfo').textContent = `æ­£åœ¨ä¸ ${callerPhone} é€šè¯`;

            const calls = getStorage(STORAGE_KEYS.calls);
            calls.push({
                type: 'outgoing',
                otherParty: callerPhone,
                time: Date.now(),
                duration: 0,
                status: 'connected'
            });
            setStorage(STORAGE_KEYS.calls, calls);
            renderCalls();
        })
        .catch(error => {
            console.error('å¤„ç†æ¥å¬å¤±è´¥:', error);
            endCall();
        });
}

function handleCandidate(targetPhone, candidate) {
    const pc = rtcConnections[targetPhone];
    if (!pc) return;

    pc.addIceCandidate(new RTCIceCandidate(candidate))
        .catch(error => console.error('æ·»åŠ ICEå€™é€‰å¤±è´¥:', error));
}

function endCall() {
    if (!currentCall) return;

    const { target } = currentCall;
    const pc = rtcConnections[target];

    if (pc) {
        pc.close();
        delete rtcConnections[target];
    }

    if (dataChannels[target]) {
        dataChannels[target].close();
        delete dataChannels[target];
    }

    sendWebrtcSignal(target, { type: 'hangup' });

    document.getElementById('callModal').classList.add('hidden');
    document.getElementById('callerInfo').textContent = 'æ­£åœ¨é€šè¯ä¸­...';
    document.getElementById('answerBtn').style.display = 'inline-flex';

    if (localAudioStream) {
        localAudioStream.getTracks().forEach(track => track.stop());
        localAudioStream = null;
    }

    const remoteAudio = document.querySelector('audio[hidden="true"]');
    if (remoteAudio) {
        document.body.removeChild(remoteAudio);
    }

    currentCall = null;
}

function handleHangup(targetPhone) {
    const pc = rtcConnections[targetPhone];
    if (pc) {
        pc.close();
        delete rtcConnections[targetPhone];
    }

    if (dataChannels[targetPhone]) {
        dataChannels[targetPhone].close();
        delete dataChannels[targetPhone];
    }

    if (currentCall && currentCall.target === targetPhone) {
        document.getElementById('callModal').classList.add('hidden');
        document.getElementById('callerInfo').textContent = 'æ­£åœ¨é€šè¯ä¸­...';
        document.getElementById('answerBtn').style.display = 'inline-flex';

        if (!currentCall.isIncoming) {
            const calls = getStorage(STORAGE_KEYS.calls);
            const lastCallIndex = calls.findLastIndex(call => 
                call.type === 'outgoing' && call.otherParty === targetPhone && call.status === 'connected'
            );
            if (lastCallIndex !== -1) {
                calls[lastCallIndex].status = 'hungup';
                calls[lastCallIndex].duration = Math.floor((Date.now() - calls[lastCallIndex].time) / 1000);
                setStorage(STORAGE_KEYS.calls, calls);
                renderCalls();
            }
        }

        currentCall = null;
    }

    if (localAudioStream) {
        localAudioStream.getTracks().forEach(track => track.stop());
        localAudioStream = null;
    }

    const remoteAudio = document.querySelector('audio[hidden="true"]');
    if (remoteAudio) {
        document.body.removeChild(remoteAudio);
    }
}

/* ===================== çŸ­ä¿¡ç›¸å…³å‡½æ•° ===================== */
async function sendSms() {
    const to = document.getElementById('smsTo').value.trim();
    const body = document.getElementById('smsBody').value.trim();

    if (!to || !body) {
        alert('è¯·è¾“å…¥æ”¶ä»¶äººå’ŒçŸ­ä¿¡å†…å®¹');
        return;
    }

    if (to.startsWith('g-')) {
        sendGroupSms(to, body);
        return;
    }

    if (!to.startsWith('+3')) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”µè¯å·ç æˆ–ç¾¤ç»„ID');
        return;
    }

    if (to === currentUser.phone) {
        alert('ä¸èƒ½ç»™è‡ªå·±å‘é€çŸ­ä¿¡');
        return;
    }

    const smsList = getStorage(STORAGE_KEYS.sms);
    const smsId = generateUUID();
    const newSms = {
        id: smsId,
        from: currentUser.phone,
        to: to,
        body: body,
        time: Date.now(),
        type: 'private',
        status: 'sending'
    };

    smsList.push(newSms);
    setStorage(STORAGE_KEYS.sms, smsList);
    renderSms();

    document.getElementById('smsBody').value = '';

    try {
        if (dataChannels[to]) {
            dataChannels[to].send(JSON.stringify({
                type: 'sms',
                body: body,
                id: smsId
            }));
            newSms.status = 'sent';
        } else {
            await createSmsDataChannel(to);
            if (dataChannels[to]) {
                dataChannels[to].send(JSON.stringify({
                    type: 'sms',
                    body: body,
                    id: smsId
                }));
                newSms.status = 'sent';
            } else {
                newSms.status = 'failed';
                throw new Error('æ— æ³•å»ºç«‹æ•°æ®é€šé“');
            }
        }
        setStorage(STORAGE_KEYS.sms, smsList);
        renderSms();
    } catch (error) {
        console.error('å‘é€çŸ­ä¿¡å¤±è´¥:', error);
        newSms.status = 'failed';
        setStorage(STORAGE_KEYS.sms, smsList);
        renderSms();
        alert('å‘é€çŸ­ä¿¡å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

async function createSmsDataChannel(targetPhone) {
    const pc = createRtcConnection(targetPhone);
    rtcConnections[targetPhone] = pc;

    const dc = pc.createDataChannel('sms-channel');
    initDataChannel(dc, targetPhone);

    try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendWebrtcSignal(targetPhone, {
            type: 'sms-offer',
            sdp: offer.toJSON()
        });

        return new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
                pc.close();
                delete rtcConnections[targetPhone];
                reject(new Error('å»ºç«‹æ•°æ®é€šé“è¶…æ—¶'));
            }, 10000);

            dc.onopen = () => {
                clearTimeout(timeout);
                resolve(dc);
            };

            dc.onerror = (error) => {
                clearTimeout(timeout);
                pc.close();
                delete rtcConnections[targetPhone];
                reject(error);
            };
        });
    } catch (error) {
        console.error('åˆ›å»ºçŸ­ä¿¡æ•°æ®é€šé“å¤±è´¥:', error);
        pc.close();
        delete rtcConnections[targetPhone];
        throw error;
    }
}

function handleSmsOffer(callerPhone, sdp) {
    const pc = createRtcConnection(callerPhone);
    rtcConnections[callerPhone] = pc;

    pc.ondatachannel = (e) => {
        initDataChannel(e.channel, callerPhone);
    };

    pc.setRemoteDescription(new RTCSessionDescription(sdp))
        .then(async () => {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            sendWebrtcSignal(callerPhone, {
                type: 'answer',
                sdp: answer.toJSON()
            });
        })
        .catch(error => {
            console.error('å¤„ç†çŸ­ä¿¡é€šé“è¯·æ±‚å¤±è´¥:', error);
            pc.close();
            delete rtcConnections[callerPhone];
        });
}

function handleSmsCandidate(targetPhone, candidate) {
    handleCandidate(targetPhone, candidate);
}

function sendGroupSms(groupId, body) {
    const groups = getStorage(STORAGE_KEYS.groups);
    const group = Object.values(groups).find(g => g.id === groupId);

    if (!group) {
        alert('ç¾¤ç»„ä¸å­˜åœ¨');
        return;
    }

    if (!group.members.includes(currentUser.phone)) {
        alert('ä½ ä¸æ˜¯è¯¥ç¾¤ç»„çš„æˆå‘˜');
        return;
    }

    const smsList = getStorage(STORAGE_KEYS.sms);
    const newSms = {
        id: generateUUID(),
        from: currentUser.phone,
        to: groupId,
        body: body,
        time: Date.now(),
        type: 'group',
        status: 'sent'
    };

    smsList.push(newSms);
    setStorage(STORAGE_KEYS.sms, smsList);
    renderSms();

    document.getElementById('smsBody').value = '';

    group.members.forEach(member => {
        if (member !== currentUser.phone && dataChannels[member]) {
            dataChannels[member].send(JSON.stringify({
                type: 'group-sms',
                groupId: groupId,
                groupName: group.name,
                from: currentUser.phone,
                body: body,
                id: newSms.id
            }));
        }
    });
}

function renderSms() {
    const smsList = getStorage(STORAGE_KEYS.sms);
    const smsContainer = document.getElementById('msgList');
    smsContainer.innerHTML = '';

    if (smsList.length === 0) {
        smsContainer.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— çŸ­ä¿¡è®°å½•</div>';
        return;
    }

    // æŒ‰æ—¶é—´å€’åºæ’åˆ—çŸ­ä¿¡
    const sortedSms = [...smsList].sort((a, b) => b.time - a.time);

    sortedSms.forEach(sms => {
        const isMe = sms.from === currentUser.phone;
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${isMe ? 'me' : 'other'}`;

        let senderInfo = isMe ? 'æˆ‘' : sms.from;
        if (sms.type === 'group') {
            senderInfo = `${sms.from}ï¼ˆ${getGroupNameById(sms.to)}ï¼‰`;
        }

        const timeStr = formatTime(sms.time);
        const statusStr = sms.status === 'sending' ? 'ğŸ”„ å‘é€ä¸­' : 
                          sms.status === 'sent' ? 'âœ… å·²å‘é€' : 'âŒ å‘é€å¤±è´¥';

        msgDiv.innerHTML = `
            <div style="font-size:12px;color:#666;">${senderInfo} Â· ${timeStr} ${isMe ? statusStr : ''}</div>
            <div style="margin:4px 0;">${sms.body}</div>
        `;

        smsContainer.appendChild(msgDiv);
    });

    // æ»šåŠ¨åˆ°åº•éƒ¨
    smsContainer.scrollTop = smsContainer.scrollHeight;
}

function getGroupNameById(groupId) {
    const groups = getStorage(STORAGE_KEYS.groups);
    const group = Object.values(groups).find(g => g.id === groupId);
    return group ? group.name : 'æœªçŸ¥ç¾¤ç»„';
}

/* ===================== ç¾¤ç»„ç›¸å…³å‡½æ•° ===================== */
function createGroup() {
    const groupName = document.getElementById('groupName').value.trim();
    if (!groupName) {
        alert('è¯·è¾“å…¥ç¾¤ç»„åç§°');
        return;
    }

    const groupId = `g-${generateUUID().slice(0, 8)}`;
    const newGroup = {
        id: groupId,
        name: groupName,
        creator: currentUser.phone,
        members: [currentUser.phone],
        createTime: Date.now()
    };

    const groups = getStorage(STORAGE_KEYS.groups);
    groups[groupId] = newGroup;
    setStorage(STORAGE_KEYS.groups, groups);

    document.getElementById('groupName').value = '';
    renderGroups();

    // ç”Ÿæˆé‚€è¯·é“¾æ¥ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰
    document.getElementById('inviteLink').value = `${window.location.origin}?joinGroup=${groupId}`;
}

function joinFromLink() {
    const inviteLink = document.getElementById('inviteLink').value.trim();
    if (!inviteLink) {
        alert('è¯·è¾“å…¥é‚€è¯·é“¾æ¥');
        return;
    }

    const urlParams = new URLSearchParams(inviteLink.split('?')[1]);
    const groupId = urlParams.get('joinGroup');
    if (!groupId || !groupId.startsWith('g-')) {
        alert('æ— æ•ˆçš„é‚€è¯·é“¾æ¥');
        return;
    }

    const groups = getStorage(STORAGE_KEYS.groups);
    const group = groups[groupId];
    if (!group) {
        alert('ç¾¤ç»„ä¸å­˜åœ¨');
        return;
    }

    if (group.members.includes(currentUser.phone)) {
        alert('ä½ å·²åœ¨è¯¥ç¾¤ç»„ä¸­');
        return;
    }

    group.members.push(currentUser.phone);
    setStorage(STORAGE_KEYS.groups, groups);

    // å‘é€å…¥ç¾¤é€šçŸ¥
    group.members.forEach(member => {
        if (member !== currentUser.phone && dataChannels[member]) {
            dataChannels[member].send(JSON.stringify({
                type: 'group-notify',
                groupId: groupId,
                groupName: group.name,
                content: `${currentUser.phone} åŠ å…¥äº†ç¾¤ç»„`
            }));
        }
    });

    renderGroups();
    alert(`æˆåŠŸåŠ å…¥ç¾¤ç»„ï¼š${group.name}`);
}

function renderGroups() {
    const groups = getStorage(STORAGE_KEYS.groups);
    const groupList = document.getElementById('groupList');
    groupList.innerHTML = '';

    if (Object.keys(groups).length === 0) {
        groupList.innerHTML = '<li style="text-align:center;color:#999;">æš‚æ— ç¾¤ç»„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç¾¤ç»„å§ï½</li>';
        return;
    }

    Object.values(groups).forEach(group => {
        const li = document.createElement('li');
        li.innerHTML = `
            <div>
                <strong>${group.name}</strong>
                <div style="font-size:12px;color:#666;">
                    æˆå‘˜ï¼š${group.members.length} äºº Â· åˆ›å»ºäº ${formatTime(group.createTime)}
                </div>
            </div>
            <div>
                <button onclick="copyInviteLink('${group.id}')" style="background:#2ecc71;margin-right:4px;">é‚€è¯·</button>
                <button onclick="leaveGroup('${group.id}')" style="background:#e74c3c;">é€€å‡º</button>
            </div>
        `;
        groupList.appendChild(li);
    });
}

function copyInviteLink(groupId) {
    const groups = getStorage(STORAGE_KEYS.groups);
    const group = groups[groupId];
    if (!group) return;

    const inviteLink = `${window.location.origin}?joinGroup=${groupId}`;
    document.getElementById('inviteLink').value = inviteLink;

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    document.getElementById('inviteLink').select();
    document.execCommand('copy');
    alert('é‚€è¯·é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
}

function leaveGroup(groupId) {
    const groups = getStorage(STORAGE_KEYS.groups);
    const group = groups[groupId];
    if (!group) return;

    if (group.creator === currentUser.phone) {
        alert('ç¾¤ä¸»ä¸èƒ½é€€å‡ºç¾¤ç»„ï¼Œè¯·å…ˆè½¬è®©ç¾¤ä¸»æˆ–è§£æ•£ç¾¤ç»„');
        return;
    }

    if (!confirm(`ç¡®å®šé€€å‡ºç¾¤ç»„ ${group.name} å—ï¼Ÿ`)) {
        return;
    }

    // ç§»é™¤æˆå‘˜
    group.members = group.members.filter(member => member !== currentUser.phone);
    setStorage(STORAGE_KEYS.groups, groups);

    // å‘é€é€€ç¾¤é€šçŸ¥
    group.members.forEach(member => {
        if (dataChannels[member]) {
            dataChannels[member].send(JSON.stringify({
                type: 'group-notify',
                groupId: groupId,
                groupName: group.name,
                content: `${currentUser.phone} é€€å‡ºäº†ç¾¤ç»„`
            }));
        }
    });

    renderGroups();
}

/* ===================== é€šè¯è®°å½•ç›¸å…³å‡½æ•° ===================== */
function renderCalls() {
    const calls = getStorage(STORAGE_KEYS.calls);
    const callHistory = document.getElementById('callHistory');
    callHistory.innerHTML = '';

    if (calls.length === 0) {
        callHistory.innerHTML = '<li style="text-align:center;color:#999;">æš‚æ— é€šè¯è®°å½•</li>';
        return;
    }

    // æŒ‰æ—¶é—´å€’åºæ’åˆ—
    const sortedCalls = [...calls].sort((a, b) => b.time - a.time);

    sortedCalls.forEach(call => {
        const li = document.createElement('li');
        const typeIcon = call.type === 'incoming' ? 'ğŸ“¥' : 'ğŸ“¤';
        const statusText = call.status === 'answered' ? 'å·²æ¥å¬' : 
                           call.status === 'connected' ? 'å·²æ¥é€š' : 
                           call.status === 'hungup' ? 'å·²æŒ‚æ–­' : 'æœªæ¥å¬';
        const durationText = call.duration > 0 ? ` Â· æ—¶é•¿ï¼š${Math.floor(call.duration / 60)}åˆ†${call.duration % 60}ç§’` : '';

        li.innerHTML = `
            <div>
                <div>${typeIcon} ${call.otherParty}</div>
                <div style="font-size:12px;color:#666;">
                    ${formatTime(call.time)} Â· ${statusText}${durationText}
                </div>
            </div>
            <button onclick="callBack('${call.otherParty}')">å›æ‹¨</button>
        `;
        callHistory.appendChild(li);
    });
}

function callBack(phone) {
    document.getElementById('dialNumber').value = phone;
    showArea(); // å›æ‹¨æ—¶åŒæ­¥æ˜¾ç¤ºå½’å±åœ°
    makeCall();
}

/* ===================== é¡µé¢å¯¼èˆªå‡½æ•° ===================== */
document.querySelectorAll('.navBtn').forEach(btn => {
    btn.addEventListener('click', function() {
        const targetPage = this.getAttribute('data-page');
        
        // åˆ‡æ¢å¯¼èˆªæ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.navBtn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // åˆ‡æ¢é¡µé¢æ˜¾ç¤º
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(targetPage).classList.add('active');
        
        // åˆ‡æ¢é¡µé¢æ—¶åˆ·æ–°å¯¹åº”æ•°æ®
        if (targetPage === 'smsPage') renderSms();
        if (targetPage === 'groupPage') renderGroups();
        if (targetPage === 'dialPage') renderCalls();
    });
});

/* ===================== ç™»å½•/é€€å‡ºç›¸å…³å‡½æ•° ===================== */
function checkLogin() {
    currentUser = getStorage(STORAGE_KEYS.currentUser);
    if (currentUser && currentUser.phone) {
        document.getElementById('userInfo').textContent = `å½“å‰å·ç ï¼š${currentUser.phone}`;
        initApp();
    } else {
        // è‡ªåŠ¨ç”Ÿæˆæˆ–è®©ç”¨æˆ·è¾“å…¥å·ç ï¼ˆç®€åŒ–ç™»å½•ï¼‰
        const phoneMap = getStorage(STORAGE_KEYS.userPhoneMap);
        const randomPhone = `+3-000-${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`;
        const defaultPhone = Object.keys(phoneMap).length > 0 ? Object.keys(phoneMap)[0] : randomPhone;
        
        const userPhone = prompt('è¯·è¾“å…¥ä½ çš„å¤§å‡‰å›½ç”µè¯å·ç ï¼ˆæˆ–ä½¿ç”¨é»˜è®¤å·ç ï¼‰ï¼š', defaultPhone);
        if (!userPhone || !userPhone.startsWith('+3')) {
            alert('æ— æ•ˆçš„ç”µè¯å·ç ï¼Œå°†ä½¿ç”¨é»˜è®¤å·ç ');
            currentUser = { phone: randomPhone, name: 'ç”¨æˆ·' + Math.floor(Math.random() * 1000) };
        } else {
            currentUser = { phone: userPhone, name: 'ç”¨æˆ·' + Math.floor(Math.random() * 1000) };
        }
        
        setStorage(STORAGE_KEYS.currentUser, currentUser);
        
        // ä¿å­˜å·ç æ˜ å°„ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·æ³¨å†Œï¼‰
        const userPhoneMap = getStorage(STORAGE_KEYS.userPhoneMap);
        userPhoneMap[currentUser.phone] = currentUser.name;
        setStorage(STORAGE_KEYS.userPhoneMap, userPhoneMap);
        
        // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        const users = getStorage(STORAGE_KEYS.users);
        if (!users[currentUser.phone]) {
            users[currentUser.phone] = currentUser;
            setStorage(STORAGE_KEYS.users, users);
        }
        
        document.getElementById('userInfo').textContent = `å½“å‰å·ç ï¼š${currentUser.phone}`;
        initApp();
    }
}

function logout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        setStorage(STORAGE_KEYS.currentUser, {});
        location.reload();
    }
}

/* ===================== åº”ç”¨åˆå§‹åŒ– ===================== */
function initApp() {
    // è¯·æ±‚é€šçŸ¥æƒé™
    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission();
    }

    // åˆå§‹åŒ–é¡µé¢æ•°æ®
    renderSms();
    renderGroups();
    renderCalls();

    // ç›‘å¬WebRTCä¿¡å·ï¼ˆè½®è¯¢æ¨¡æ‹Ÿï¼‰
    setInterval(() => {
        const signals = getStorage(STORAGE_KEYS.webrtcSignals);
        if (signals[currentUser.phone] && signals[currentUser.phone].length > 0) {
            const newSignals = signals[currentUser.phone];
            newSignals.forEach(signal => handleWebrtcSignal(signal));
            // æ¸…ç©ºå·²å¤„ç†çš„ä¿¡å·
            signals[currentUser.phone] = [];
            setStorage(STORAGE_KEYS.webrtcSignals, signals);
        }
    }, 1000);
}

/* ===================== é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– ===================== */
window.onload = function() {
    checkLogin();
    showArea(); // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºå½’å±åœ°æç¤º
};
</script>
</body>
</html>
