<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¤§å‡‰å›½äº‘é€šä¿¡</title>
<meta name="theme-color" content="#004bbb">
<style>
:root{--main:#004bbb;--bg:#f4f4f9}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;background:var(--bg)}
header{background:var(--main);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
#screen{max-width:600px;margin:0 auto;background:#fff;min-height:100vh;display:flex;flex-direction:column}
#nav{display:flex;border-bottom:1px solid #ddd}
#nav button{flex:1;padding:10px;border:none;background:#fff;cursor:pointer;transition:.2s}
#nav button.active{background:var(--main);color:#fff}
.page{display:none;padding:16px;flex:1}
.page.active{display:block}
input,textarea,select{width:100%;padding:8px;margin:6px 0;box-sizing:border-box;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;border:none;border-radius:4px;background:var(--main);color:#fff;cursor:pointer}
button:disabled{background:#aaa}
.call-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.call-pad button{padding:18px;font-size:20px}
#callStatus{font-size:18px;margin:10px 0}
#msgList{max-height:40vh;overflow:auto;border:1px solid #ddd;padding:6px;border-radius:4px;background:#fafafa}
.msg{margin:4px 0}.msg.me{text-align:right}
.group-invite{background:#ffe7ba;padding:6px;border-radius:4px;margin:4px 0}
#phoneList{list-style:none;padding:0}
#phoneList li{background:#f9f9f9;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
<div id="screen">
  <header>
    <span>ğŸ“ å¤§å‡‰å›½äº‘é€šä¿¡</span>
    <span id="userInfo"></span>
    <button onclick="logout()" style="padding:4px 8px;font-size:14px;">é€€å‡º</button>
  </header>

  <nav id="nav">
    <button class="navBtn active" data-page="dialPage">æ‹¨å·</button>
    <button class="navBtn" data-page="smsPage">çŸ­ä¿¡</button>
    <button class="navBtn" data-page="groupPage">ç¾¤ç»„</button>
    <button onclick="location.href='./gen.html'">ç”Ÿå·</button>
  </nav>

  <!-- æ‹¨å· -->
  <section id="dialPage" class="page active">
    <h3>æ‹¨å·ç›˜</h3>
    <input id="dialNumber" placeholder="ä¾‹ï¼š+3-000-12345678">
    <div class="call-pad">
      <button onclick="press('1')">1</button><button onclick="press('2')">2</button><button onclick="press('3')">3</button>
      <button onclick="press('4')">4</button><button onclick="press('5')">5</button><button onclick="press('6')">6</button>
      <button onclick="press('7')">7</button><button onclick="press('8')">8</button><button onclick="press('9')">9</button>
      <button onclick="press('*')">*</button><button onclick="press('0')">0</button><button onclick="press('#')">#</button>
      <button onclick="delLast()" style="grid-column:2">âŒ«</button>
    </div>
    <button onclick="makeCall()">ğŸ“ æ‹¨æ‰“</button>
    <div id="callStatus"></div>
  </section>

  <!-- çŸ­ä¿¡ -->
  <section id="smsPage" class="page">
    <h3>æ”¶å‘çŸ­ä¿¡</h3>
    <input id="smsTo" placeholder="æ¥æ”¶æ–¹å·ç ">
    <textarea id="smsBody" rows="3" placeholder="çŸ­ä¿¡å†…å®¹" maxlength="500"></textarea>
    <button onclick="sendSms()">å‘é€</button>
    <h4>å†å²è®°å½•</h4>
    <div id="msgList"></div>
  </section>

  <!-- ç¾¤ç»„ -->
  <section id="groupPage" class="page">
    <h3>ç¾¤ç»„</h3>
    <input id="groupName" placeholder="æ–°ç¾¤ç»„åç§°" maxlength="30">
    <button onclick="createGroup()">åˆ›å»ºç¾¤ç»„</button>
    <h4>æˆ‘çš„ç¾¤ç»„</h4>
    <ul id="groupList"></ul>
    <h4>é‚€è¯·é“¾æ¥ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰</h4>
    <input id="inviteLink" readonly>
    <button onclick="joinFromLink()">é€šè¿‡é“¾æ¥åŠ å…¥</button>
  </section>
</div>

<script>
/* ===================== åŸºç¡€å˜é‡ ===================== */
let currentUser;

/* ===================== ç™»å½•æ ¡éªŒ ===================== */
(function(){
  const name=localStorage.getItem('dl_currentUser');
  if(!name){location.href='./index.html';return;}
  currentUser=name;
  document.getElementById('userInfo').textContent=name;
})();

/* ===================== é¡µé¢åˆ‡æ¢ ===================== */
document.querySelectorAll('.navBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.navBtn').forEach(b=>b.classList.remove('active'));
    const page=document.getElementById(btn.dataset.page);
    if(page){page.classList.add('active');}
    btn.classList.add('active');
    if(btn.dataset.page==='smsPage')renderSms();
    if(btn.dataset.page==='groupPage')renderGroups();
  });
});

/* ===================== æ‹¨å· ===================== */
function press(ch){document.getElementById('dialNumber').value+=ch;}
function delLast(){const n=document.getElementById('dialNumber');n.value=n.value.slice(0,-1);}
let callAudio=null;
function makeCall(){
  const num=document.getElementById('dialNumber').value.trim();
  if(!num){alert('è¯·è¾“å…¥å·ç ');return;}
  if(!num.startsWith('+3')){alert('å¤§å‡‰å›½å·ç å¿…é¡»ä»¥ +3 å¼€å¤´');return;}
  document.getElementById('callStatus').textContent='æ­£åœ¨æ‹¨å·â€¦';
  startCallTone();
  setTimeout(()=>{
    stopCallTone();
    document.getElementById('callStatus').textContent='é€šè¯ä¸­ï¼ˆæ¨¡æ‹Ÿï¼‰';
    setTimeout(()=>{
      document.getElementById('callStatus').textContent='é€šè¯ç»“æŸ';
      pushNotification(`å·²ç»“æŸä¸ ${num} çš„é€šè¯`);
    },3000);
  },2000);
}
function startCallTone(){
  const AudioCtx=window.AudioContext||window.webkitAudioContext;
  callAudio=new AudioCtx();
  const osc=callAudio.createOscillator();
  osc.type='sine';osc.frequency.value=440;
  const gain=callAudio.createGain();gain.gain.value=0.2;
  osc.connect(gain).connect(callAudio.destination);
  osc.start();callAudio.osc=osc;
}
function stopCallTone(){
  if(callAudio&&callAudio.osc){callAudio.osc.stop();if(callAudio.close)callAudio.close();}
}

/* ===================== çŸ­ä¿¡ ===================== */
function sendSms(){
  const to=document.getElementById('smsTo').value.trim();
  const body=document.getElementById('smsBody').value.trim();
  if(!to||!body){alert('è¯·è¾“å…¥å®Œæ•´');return;}
  if(!to.startsWith('+3')){alert('å·ç å¿…é¡»ä»¥ +3 å¼€å¤´');return;}
  const smsList=JSON.parse(localStorage.getItem('dl_sms')||'[]');
  smsList.push({from:currentUser,to,body,time:Date.now(),dir:'out'});
  localStorage.setItem('dl_sms',JSON.stringify(smsList));
  setTimeout(()=>{
    const inbox=JSON.parse(localStorage.getItem('dl_sms')||'[]');
    inbox.push({from:to,to:currentUser,body:`ã€è‡ªåŠ¨å›å¤ã€‘${body}`,time:Date.now(),dir:'in'});
    localStorage.setItem('dl_sms',JSON.stringify(inbox));
    pushNotification(`æ–°çŸ­ä¿¡æ¥è‡ª ${to}`);
    if(document.getElementById('smsPage').classList.contains('active'))renderSms();
  },1000);
  document.getElementById('smsBody').value='';renderSms();
}
function renderSms(){
  const box=document.getElementById('msgList');
  box.innerHTML='';
  const smsList=JSON.parse(localStorage.getItem('dl_sms')||'[]');
  const mySms=smsList.filter(m=>m.from===currentUser||m.to
===currentUser);
mySms.sort((a,b)=>a.time-b.time);
mySms.forEach(m=>{
const div=document.createElement('div');
div.className='msg '+(m.dir==='out'?'me':'');
div.textContent=(m.dir==='in'?'â† '+m.from+'ï¼š':'â†’ ')+m.body;
box.appendChild(div);
});
box.scrollTop=box.scrollHeight;
}

/ ===================== ç¾¤ç»„ ===================== /
function createGroup(){
const name=document.getElementById('groupName').value.trim();
if(!name){alert('è¯·è¾“å…¥ç¾¤ç»„å');return;}
const gid='g'+(self.crypto.randomUUID?self.crypto.randomUUID():Date.now()+Math.random().toString(36));
const groups=JSON.parse(localStorage.getItem('dl_groups')||'{}');
groups[gid]={name,members:[currentUser]};
localStorage.setItem('dl_groups',JSON.stringify(groups));
const users=JSON.parse(localStorage.getItem('dl_users')||'{}');
users[currentUser].groups.push(gid);
localStorage.setItem('dl_users',JSON.stringify(users));
document.getElementById('groupName').value='';renderGroups();
}
function renderGroups(){
const ul=document.getElementById('groupList');
ul.innerHTML='';
const users=JSON.parse(localStorage.getItem('dl_users')||'{}');
const groups=JSON.parse(localStorage.getItem('dl_groups')||'{}');
users[currentUser].groups.forEach(gid=>{
if(!groups[gid])return;
const li=document.createElement('li');
li.textContent=groups[gid].name;
const inviteBtn=document.createElement('button');
inviteBtn.textContent='å¤åˆ¶é‚€è¯·';inviteBtn.style.marginLeft='6px';inviteBtn.onclick=()=>{
const link=`${location.origin}${location.pathname.replace('app.html','')}#invite=${gid}`;
if(navigator.clipboard){navigator.clipboard.writeText(link);}else{const inp=document.getElementById('inviteLink');inp.value=link;inp.focus();inp.select();}
document.getElementById('inviteLink').value=link;
alert('é‚€è¯·é“¾æ¥å·²å¤åˆ¶');
};
li.appendChild(inviteBtn);ul.appendChild(li);
});
}
function joinFromLink(){
const raw=document.getElementById('inviteLink').value.trim();
const m=raw.match(/invite=([^&]+)/);
if(!m)return alert('æ— æ•ˆé“¾æ¥');
const gid=m[1];
const groups=JSON.parse(localStorage.getItem('dl_groups')||'{}');
if(!groups[gid])return alert('ç¾¤ç»„ä¸å­˜åœ¨');
if(groups[gid].members.includes(currentUser))return alert('ä½ å·²åœ¨ç¾¤ä¸­');
groups[gid].members.push(currentUser);
localStorage.setItem('dl_groups',JSON.stringify(groups));
const users=JSON.parse(localStorage.getItem('dl_users')||'{}');
users[currentUser].groups.push(gid);
localStorage.setItem('dl_users',JSON.stringify(users));
renderGroups();
pushNotification(`å·²åŠ å…¥ç¾¤ç»„ï¼š${groups[gid].name}`);
}

/ ===================== é€šçŸ¥ ===================== /
function pushNotification(body){
if(Notification.permission==='granted'){
new Notification('å¤§å‡‰å›½äº‘é€šä¿¡',{body,icon:'ğŸ“'});
}else if(Notification.permission!=='denied'){
Notification.requestPermission().then(p=>{if(p==='granted')pushNotification(body);});
}
}

/ ===================== é€€å‡º ===================== /
function logout(){
localStorage.removeItem('dl_currentUser');
location.href='./index.html';
}

</body>
</html>
```
